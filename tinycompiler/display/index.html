
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://ssloy.github.io/tinycompiler/display/">
      
      
        <link rel="prev" href="../symtable/">
      
      
        <link rel="next" href="../assembly/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Displays - Playing with code</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-7F81P6F3D0"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-7F81P6F3D0",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-7F81P6F3D0",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#displays" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Playing with code" class="md-header__button md-logo" aria-label="Playing with code" data-md-component="logo">
      
  <img src="../../haqreu-plate.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Playing with code
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Displays
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Playing with code" class="md-nav__button md-logo" aria-label="Playing with code" data-md-component="logo">
      
  <img src="../../haqreu-plate.png" alt="logo">

    </a>
    Playing with code
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    tinyrenderer
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            tinyrenderer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/bresenham/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bresenham’s line drawing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/rasterization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Triangle rasterization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/barycentric/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Barycentric coordinates
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/z-buffer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hidden faces removal
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/camera-naive/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Naive camera handling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/camera/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Better camera
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/shading/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Shading
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/textures/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    More data!
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/tangent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tangent space
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/shadow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Shadow mapping
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/ssao/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ambient occlusion
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/toon/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bonus: toon shading
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/afterword/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Afterword
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    tinycompiler
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            tinycompiler
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ast/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Abstract syntax trees
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sly/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SLY: lexer and parser
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../symtable/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Symbol tables
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Displays
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Displays
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recursion-for-beginners" class="md-nav__link">
    <span class="md-ellipsis">
      Recursion for Beginners
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-main-idea-of-this-article" class="md-nav__link">
    <span class="md-ellipsis">
      The main idea of this article
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-case" class="md-nav__link">
    <span class="md-ellipsis">
      Test Case
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercise-1" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 1
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#symbol-tables-to-the-rescue" class="md-nav__link">
    <span class="md-ellipsis">
      Symbol Tables to the Rescue
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercise-2" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 2
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#final-stretch-evaluating-expressions" class="md-nav__link">
    <span class="md-ellipsis">
      Final stretch: evaluating expressions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../assembly/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Assembly generation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lexer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DIY lexer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../parser/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DIY parser
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../afterword/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Afterword
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    tinyoptimizer
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            tinyoptimizer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyoptimizer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyoptimizer/mem2reg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    mem2reg
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    tinyfloat
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            tinyfloat
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyfloat/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyfloat/computers-and-numbers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Computers and Numbers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyfloat/print/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Printing floats
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyfloat/add/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Addition
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    strange things
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            strange things
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strange/cursed-fire/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cursed fire or #define black magic
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recursion-for-beginners" class="md-nav__link">
    <span class="md-ellipsis">
      Recursion for Beginners
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-main-idea-of-this-article" class="md-nav__link">
    <span class="md-ellipsis">
      The main idea of this article
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-case" class="md-nav__link">
    <span class="md-ellipsis">
      Test Case
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercise-1" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 1
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#symbol-tables-to-the-rescue" class="md-nav__link">
    <span class="md-ellipsis">
      Symbol Tables to the Rescue
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercise-2" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 2
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#final-stretch-evaluating-expressions" class="md-nav__link">
    <span class="md-ellipsis">
      Final stretch: evaluating expressions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="displays">Displays</h1>
<h2 id="introduction">Introduction</h2>
<p>A question from the realm of abnormal programming: how complex of a program can you write in python without using variables (or function arguments) at all, except for a couple of global arrays?
The correct answer: anything.
If something can be done in assembly, then it can certainly be done in python!</p>
<p>Despite the fact that tinycompiler targets GNU assembly, I'm not crazy enough to dive into assembly directly.
I am getting to assembly pretty gradually:
I started by translating <em>wend</em> sources into full-blown python, and now I am reducing the set of features I am allowed to use.
The topic of today's discussion: generating python code without using variables.</p>
<h2 id="recursion-for-beginners">Recursion for Beginners</h2>
<p>The factorial of a positive integer <span class="arithmatex">\(n\)</span> is the product of all positive integers less than or equal to <span class="arithmatex">\(n\)</span>.
For example, the factorial of 7 is <span class="arithmatex">\(7*6*5*4*3*2*1\)</span>, which equals 5040.
The factorial of <span class="arithmatex">\(n\)</span> is written as <span class="arithmatex">\(n!\)</span>, and the task of computing it is obviously reduced to computing <span class="arithmatex">\((n-1)!\)</span>, namely, <span class="arithmatex">\(n! = n * (n - 1)!\)</span></p>
<p>A recursive implementation naturally comes to the mind:</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">ssloy</span><span class="nd">@khronos</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">python3</span> <span class="o">&lt;&lt;&lt;</span><span class="s1">&#39;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">return</span> <span class="n">result</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="nb">print</span><span class="p">(</span><span class="n">factorial</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="s1">&#39;</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="mi">5040</span>
</span></code></pre></div>
<p>This kind of code is often the starting point for learning programming, but explanations of how exactly the machine executes it are usually left out.
The main tool in this program is the function call, but how does it work?</p>
<p>A typical (not the only possible, but typical) way for implementing a function call is based on saving the function's arguments and local variables on the stack:</p>
<ol>
<li>At the call point, the parameters passed to the function are placed on the stack (plus usually the return address for the instruction pointer).</li>
<li>The called function places its own local variables on the stack during execution.</li>
<li>Upon completion, the function clears the stack of its local variables, and writes the result (usually in one of the processor's registers or again in some place reserved on the stack by the caller).</li>
<li>The return instruction jumps to the return address.
Either immediately before or right after returning from the function, the stack is cleared of the function's arguments.</li>
</ol>
<p>It is easy to see that the need to grow the stack is dictated by the requirement to restore the state of the calling function instance (i.e., its parameters, local data, and return address) after the called function finishes execution.</p>
<p>Thus, with each recursive function call, a new set of its parameters and local variables is created, which, along with the return address, is placed on the stack.
To avoid being theoretical and to be more practical, let's add one line of introspection to our factorial:</p>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span>
<span class="normal"><a href="#__codelineno-1-19">19</a></span>
<span class="normal"><a href="#__codelineno-1-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="n">ssloy</span><span class="nd">@khronos</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">python3</span> <span class="o">&lt;&lt;&lt;</span><span class="s1">&#39;</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="hll"><span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
</span></span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a>    <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="hll">    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;instances of n:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])])</span>
</span></span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a>    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a>    <span class="k">return</span> <span class="n">result</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="nb">print</span><span class="p">(</span><span class="n">factorial</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="s1">&#39;</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="n">instances</span> <span class="n">of</span> <span class="n">n</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">]</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="n">instances</span> <span class="n">of</span> <span class="n">n</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="n">instances</span> <span class="n">of</span> <span class="n">n</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="n">instances</span> <span class="n">of</span> <span class="n">n</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="n">instances</span> <span class="n">of</span> <span class="n">n</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="n">instances</span> <span class="n">of</span> <span class="n">n</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="n">instances</span> <span class="n">of</span> <span class="n">n</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="mi">5040</span>
</span></code></pre></div></td></tr></table></div>
<p>With each call to <code>factorial(n)</code>, the line I added traverses the stack and prints all instances of the variable <code>n</code> that it finds.
To compute 7!, the <code>factorial(n)</code> function is called 7 times, and it is easy to see that at some point, the machine stores all 7 instances of the variable.
Of course, the same is true for the variable <code>result</code>.</p>
<h2 id="the-main-idea-of-this-article">The main idea of this article</h2>
<p>Python does a lot of work for us, but that doesn't mean we can't manage without its help.
Assembly doesn't provide the luxury of automatic argument passing; we have to deal with the stack.
I propose to continue using python as the target language but to reduce the used capabilities to the level of assembly: in fact, we will be writing in assembly with python syntax.
This approach has two advantages:</p>
<ol>
<li>
<p>We don't have to strictly follow all the constraints at once.
For example, I can limit the ability to pass arguments to functions but don't have to immediately jump into a world with four registers.
I can still use python's expression parser, writing a comfortable <code>5//-3</code> if needed,
instead of fiddling with all the required registers and necessary flags.
Thus, at all times, I can have a working compiler and refine it gradually.</p>
</li>
<li>
<p>Additionally, we don't have to dive headfirst into an unfriendly world where even a simple print() often doesn't work, and debugging assembly is a whole different story.
We can use our favorite IDE, set breakpoints, print anything to the screen, and comfortably modify the generated code by hand to understand what went wrong.</p>
</li>
</ol>
<p>We don't have to use python's built-in stack; we can emulate its behavior with a custom stack.
Let's create a global array <code>stack</code> and store the arguments and local variables of functions in it.
Then the factorial can be rewritten (by hand!) as follows:</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">ssloy</span><span class="nd">@khronos</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">python3</span> <span class="o">&lt;&lt;&lt;</span><span class="s1">&#39;</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">factorial</span><span class="p">():</span>                             <span class="c1"># n is stack[-1]</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="k">if</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>                        <span class="c1"># n is stack[-2], result is stack[-1]</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>        <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>        <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">()</span>  <span class="c1"># n is stack[-3], result is stack[-2]</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>        <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>    <span class="k">return</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="nb">print</span><span class="p">(</span><span class="n">factorial</span><span class="p">())</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="s1">&#39;</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="mi">5040</span>
</span></code></pre></div>
<p>In this code, we no longer use python variables at all, except for a single array <code>stack</code>.
This program closely resembles what I want to achieve automatically with my compiler, and the transition from the previous code to this one is the main idea of the article.
Put down your cup of tea, look at the code carefully, and if necessary, draw the stack on paper.</p>
<p>I wrote the code by hand, and I don't particularly like that I had to manually track the position of variables on the stack.
To refer to the same variable <code>n</code>, I had to use three different expressions <code>stack[-1]</code>, <code>stack[-2]</code>, and <code>stack[-3]</code>.
This is not very good, and we need to find a more robust method.
It's time to recall the symbol tables from the <a href="../symtable/">previous article</a>.</p>
<h2 id="test-case">Test Case</h2>
<p>Let's put aside the factorial and consider the simplest nontrivial example with several different function calls.
On the left, you see the original code in wend, and on the right, its translation into python using <a href="https://github.com/ssloy/tinycompiler/releases/tag/v0.0.3">version v0.0.3</a> of my compiler.
This version was described in the <a href="../symtable/">previous article</a> on symbol tables.
The task at hand is to rewrite the right part <strong>by hand</strong> without using variables, much like I did with the factorial.</p>
<p><a href="sopfr1.png"><img alt="" src="sopfr1.png" /></a></p>
<p>If the code in the picture is too hard to read, let me provide it as plain text:</p>
<details class="example">
<summary>sopfr.wend</summary>
<div class="language-cpp highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span>
<span class="normal"><a href="#__codelineno-3-21">21</a></span>
<span class="normal"><a href="#__codelineno-3-22">22</a></span>
<span class="normal"><a href="#__codelineno-3-23">23</a></span>
<span class="normal"><a href="#__codelineno-3-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">fun</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="n">fun</span><span class="w"> </span><span class="n">sopfr</span><span class="p">(</span><span class="n">n</span><span class="o">:</span><span class="kt">int</span><span class="p">)</span><span class="o">:</span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">        </span><span class="n">var</span><span class="w"> </span><span class="n">div</span><span class="o">:</span><span class="kt">int</span><span class="p">;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">        </span><span class="n">fun</span><span class="w"> </span><span class="n">sopfr_aux</span><span class="p">(</span><span class="n">n</span><span class="o">:</span><span class="kt">int</span><span class="p">)</span><span class="o">:</span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">            </span><span class="n">var</span><span class="w"> </span><span class="n">rec</span><span class="o">:</span><span class="kt">int</span><span class="p">;</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">            </span><span class="n">rec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">div</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">                </span><span class="n">rec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">div</span><span class="p">;</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">n</span><span class="o">!=</span><span class="n">div</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">                    </span><span class="n">rec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rec</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sopfr_aux</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="n">div</span><span class="p">);</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">                </span><span class="n">div</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">div</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">                </span><span class="n">rec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sopfr_aux</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">rec</span><span class="p">;</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18"></a>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">        </span><span class="n">div</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sopfr_aux</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22"></a>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">    </span><span class="n">println</span><span class="w"> </span><span class="n">sopfr</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</details>
<details class="example">
<summary>sopfr.py</summary>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">sopfr</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">sopfr_aux</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a>            <span class="k">nonlocal</span> <span class="n">div</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a>            <span class="n">rec</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a>            <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="n">div</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a>                <span class="n">rec</span> <span class="o">=</span> <span class="n">div</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a>                <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="n">div</span><span class="p">:</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a>                    <span class="n">rec</span> <span class="o">=</span> <span class="n">rec</span> <span class="o">+</span> <span class="n">sopfr_aux</span><span class="p">(</span><span class="n">n</span> <span class="o">//</span> <span class="n">div</span><span class="p">)</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a>                <span class="n">div</span> <span class="o">=</span> <span class="n">div</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a>                <span class="n">rec</span> <span class="o">=</span> <span class="n">sopfr_aux</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a>            <span class="k">return</span> <span class="n">rec</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14"></a>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15"></a>        <span class="n">div</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16"></a>        <span class="k">return</span> <span class="n">sopfr_aux</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17"></a>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">sopfr</span><span class="p">(</span><span class="mi">42</span><span class="p">))</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19"></a>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="n">main</span><span class="p">()</span>
</span></code></pre></div></td></tr></table></div>
</details>
<p>This program computes the sum of prime factors for a given number.
For example, <span class="arithmatex">\(20 = 5*2*2\)</span>, so <span class="arithmatex">\(\mathrm{sopfr}(20) = 2 + 2 + 5 = 9\)</span>.
This function is often called the <a href="https://oeis.org/A001414">integer logarithm</a>, which is not surprising since it is quite evident that <span class="arithmatex">\(\mathrm{sopfr}(a * b) = \mathrm{sopfr}(a) + \mathrm{sopfr}(b)\)</span>.
Mathematicians actively study the properties of this function, but that is somewhat beyond our discussion :)</p>
<p>In this code, I am interested in several things:</p>
<ol>
<li>We have three nested scopes.</li>
<li>We have functions with different numbers of arguments and different numbers of local functions.</li>
<li>We have a reference to a <strong>non-local</strong> variable <code>div</code> from the function <code>sopfr_aux</code>.</li>
</ol>
<p>The last point is of particular interest.
Let's recall that in the factorial example, I had to manually track the position of local variables on the stack, whose size evolved.
This is unpleasant but not too bad, as all stack changes within a function are known at compile time: initially, I refer to the variable <code>n</code> as <code>stack[-1]</code>,
and after adding the local variable <code>result</code>, the stack grows, and <code>n</code> becomes the second-to-last element <code>stack[-2]</code>.
But what to do when the stack changes at runtime? This happens quite regularly.</p>
<h2 id="exercise-1">Exercise 1</h2>
<p>Let's return to our test case of computing <code>sopfr(n)</code>. Set a breakpoint on the line <code>rec = div</code>:</p>
<p><img alt="" src="sopfr-breakpoint.png" /></p>
<p>42 decomposes into the factors 2, 3, and 7, meaning the interpreter should pass through this line three times.
Take a piece of paper and a pencil, and draw the stack state at each of the three passes (I am interested only in variables, no need for addresses).</p>
<p>Let me help with the first breakpoint.
The <code>main()</code> function places 42 on the stack, which corresponds to the variable <code>n</code> in the <code>sopfr(n)</code> function.
It, in turn, places 2 on the stack (variable <code>div</code>), and then places 42 again (argument for the <code>sopfr_aux(n)</code> function).
Then <code>sopfr_aux</code> creates a local variable <code>rec</code>, placing 0 on the stack, and reaches the breakpoint because 42 is divisible by 2.
Thus, when we reach the breakpoint for the first time, the stack will look like this: [42, 2, 42, 0].
Here is a small animation of the process:</p>
<p><img alt="" src="sopfr-stack-animation.gif" /></p>
<p>Now, take a break from the article and try drawing the stack for the second and third breakpoints.
The task is trivial, but I bet many will make mistakes.
If anyone made a mistake, don't hesitate to comment :)</p>
<details class="question">
<summary>Question</summary>
<p><img alt="" src="sopfr-stack.png" /></p>
</details>
<p>Don't be surprised, this is a perfectly normal answer. Here, I added a bit of code introspection to check the result:</p>
<details class="example">
<summary>Proof</summary>
<div class="language-py highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">ssloy</span><span class="nd">@khronos</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">python3</span> <span class="o">&lt;&lt;&lt;</span><span class="s1">&#39;</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">sopfr</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">sopfr_aux</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>            <span class="k">nonlocal</span> <span class="n">div</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>            <span class="n">rec</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>            <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="n">div</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>                <span class="c1"># breakpoint, print stack</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>                <span class="n">var</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;main&quot;</span><span class="p">:[],</span> <span class="s2">&quot;sopfr&quot;</span><span class="p">:[</span><span class="s2">&quot;n&quot;</span><span class="p">,</span><span class="s2">&quot;div&quot;</span><span class="p">],</span> <span class="s2">&quot;sopfr_aux&quot;</span><span class="p">:[</span><span class="s2">&quot;n&quot;</span><span class="p">,</span><span class="s2">&quot;rec&quot;</span><span class="p">]}</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>                <span class="nb">print</span><span class="p">([</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">var</span><span class="p">[</span><span class="n">frame</span><span class="p">[</span><span class="mi">3</span><span class="p">]]])</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>                <span class="n">rec</span> <span class="o">=</span> <span class="n">div</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>                <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="n">div</span><span class="p">:</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>                    <span class="n">rec</span> <span class="o">=</span> <span class="n">rec</span> <span class="o">+</span> <span class="n">sopfr_aux</span><span class="p">(</span><span class="n">n</span> <span class="o">//</span> <span class="n">div</span><span class="p">)</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>                <span class="n">div</span> <span class="o">=</span> <span class="n">div</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>                <span class="n">rec</span> <span class="o">=</span> <span class="n">sopfr_aux</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>            <span class="k">return</span> <span class="n">rec</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>        <span class="n">div</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>        <span class="k">return</span> <span class="n">sopfr_aux</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">sopfr</span><span class="p">(</span><span class="mi">42</span><span class="p">))</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a><span class="n">main</span><span class="p">()</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a><span class="s1">&#39;</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a><span class="p">[</span><span class="mi">42</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a><span class="p">[</span><span class="mi">42</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a><span class="p">[</span><span class="mi">42</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a><span class="mi">12</span>
</span></code></pre></div>
</details>
<h2 id="symbol-tables-to-the-rescue">Symbol Tables to the Rescue</h2>
<p>When I rewrote the factorial in assembly-like Python, I accessed variables simply by their offset from the top of the stack, and even for a local variable, this offset was not the same for different lines, but at least it was known at compile time.
Here, things are quite different.
When we reach our breakpoint, we want to assign <code>div</code> to <code>rec</code>: one variable is local, and the other is non-local and very deeply buried in the stack; the depth is unknown at compile time.
On the other hand... Let's take a look at the symbol table for our program:</p>
<p><img alt="" src="sopfr-symtable1.png" /></p>
<p>We have three nested variable scopes: <code>main</code>, <code>sopfr</code>, <code>sopfr_aux</code>.</p>
<p>There are no variables in the <code>main</code> function, <code>sopfr</code> has two integer variables <code>n</code> and <code>div</code>, and <code>sopfr_aux</code> has two integer variables <code>n</code> and <code>rec</code>.</p>
<p>Until now, my compiler accessed variables by their names, but now it's time to number them and forget about the identifiers.
Here is the <a href="https://github.com/ssloy/tinycompiler/commit/0c3ba224d7e1200b0fb15166a48c6af7ac003e70#diff-b60626824b61e9cb42755e5894e5b70f529425116f6c93e40d785f6f31754ffe">diff of the commit</a>,
in which I simply added counters for scopes and variables within each scope.
In fact, I added these purple numbers to the symbol table:</p>
<p><img alt="" src="sopfr-symtable2.png" /></p>
<p>Now, when I want to access the variable <code>div</code>, I don't need its identifier; I only need to know that it is variable number 1 in scope 1, i.e., a pair of numbers is sufficient for identification.
Now we have everything we need to eliminate variables for <code>sopfr</code>, which is considerably more complex than the factorial example.
Remember, I am still writing the code by hand; I need this to understand how my compiler will work.</p>
<p>Here is the code as an image:</p>
<p><a href="sopfr2.png"><img alt="" src="sopfr2.png" /></a></p>
<p>And here it is as text:</p>
<details class="example">
<summary>sopfr-no-variables.py</summary>
<div class="language-py highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">ssloy</span><span class="nd">@khronos</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">python3</span> <span class="o">&lt;&lt;&lt;</span><span class="s1">&#39;</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">sopfr</span><span class="p">():</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">sopfr_aux</span><span class="p">():</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>            <span class="k">global</span> <span class="n">display</span><span class="p">,</span><span class="n">stack</span><span class="p">,</span><span class="n">eax</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>            <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span>        <span class="c1"># allocate memory for one local variable rec</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>            <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>    <span class="c1"># save old frame pointer</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>            <span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span> <span class="c1"># frame pointer for sopfr_aux()</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>            <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># rec = 0</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>            <span class="k">if</span> <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># if n % div == 0</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>                <span class="nb">print</span><span class="p">(</span><span class="n">display</span><span class="p">,</span><span class="n">stack</span><span class="p">)</span>  <span class="c1"># BREAKPOINT!</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>                <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>       <span class="c1"># rec = div</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>                <span class="k">if</span>  <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># if n != div</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>                    <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span> <span class="c1"># push n/div ┐</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>                    <span class="n">sopfr_aux</span><span class="p">()</span>                                         <span class="c1">#            &gt; sopfr_aux(n/div)</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>                    <span class="k">del</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>                                      <span class="c1">#  pop n/div ┘</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>                    <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">eax</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>                <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>                <span class="n">stack</span> <span class="o">+=</span><span class="p">[</span><span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">0</span><span class="p">]]</span> <span class="c1"># push n  ┐</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>                <span class="n">sopfr_aux</span><span class="p">()</span>                   <span class="c1">#         &gt; sopfr_aux(n) call</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>                <span class="k">del</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>                <span class="c1">#  pop n  ┘</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>                <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">eax</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>            <span class="n">eax</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>            <span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>  <span class="c1"># restore frame pointer</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>            <span class="k">del</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>            <span class="c1"># remove rec from stack</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>        <span class="k">global</span> <span class="n">display</span><span class="p">,</span><span class="n">stack</span><span class="p">,</span><span class="n">eax</span>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a>        <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span>         <span class="c1"># allocate memory for one local variable div</span>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a>        <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>     <span class="c1"># save old frame pointer</span>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a>        <span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span> <span class="c1"># frame pointer for sopfr()</span>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a>        <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>   <span class="c1"># div = 2</span>
</span><span id="__span-6-35"><a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>        <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">0</span><span class="p">]]</span> <span class="c1"># push n ┐</span>
</span><span id="__span-6-36"><a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>        <span class="n">sopfr_aux</span><span class="p">()</span>                    <span class="c1">#        &gt; sopfr_aux(n)</span>
</span><span id="__span-6-37"><a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>        <span class="k">del</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>                 <span class="c1">#  pop n ┘</span>
</span><span id="__span-6-38"><a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a>        <span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>  <span class="c1"># restore frame pointer</span>
</span><span id="__span-6-39"><a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a>        <span class="k">del</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>            <span class="c1"># remove div from stack</span>
</span><span id="__span-6-40"><a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a>
</span><span id="__span-6-41"><a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a>    <span class="k">global</span> <span class="n">display</span><span class="p">,</span><span class="n">stack</span><span class="p">,</span><span class="n">eax</span>
</span><span id="__span-6-42"><a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a>    <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mi">0</span>           <span class="c1"># no local variables</span>
</span><span id="__span-6-43"><a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a>    <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>       <span class="c1"># save old frame pointer</span>
</span><span id="__span-6-44"><a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a>    <span class="n">display</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>   <span class="c1"># frame pointer for main()</span>
</span><span id="__span-6-45"><a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a>    <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">42</span><span class="p">]</span>               <span class="c1"># push 42 ┐</span>
</span><span id="__span-6-46"><a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a>    <span class="n">sopfr</span><span class="p">()</span>                     <span class="c1">#         &gt; sopfr(42)</span>
</span><span id="__span-6-47"><a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a>    <span class="k">del</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>              <span class="c1">#  pop 42 ┘</span>
</span><span id="__span-6-48"><a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">eax</span><span class="p">)</span>
</span><span id="__span-6-49"><a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a>    <span class="n">display</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>    <span class="c1"># restore frame pointer</span>
</span><span id="__span-6-50"><a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a>
</span><span id="__span-6-51"><a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a><span class="n">display</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">None</span> <span class="p">]</span><span class="o">*</span><span class="mi">3</span> <span class="c1"># uninitialized frame pointers</span>
</span><span id="__span-6-52"><a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a><span class="n">stack</span>   <span class="o">=</span> <span class="p">[]</span>         <span class="c1"># empty stack</span>
</span><span id="__span-6-53"><a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a><span class="n">eax</span>     <span class="o">=</span> <span class="kc">None</span>       <span class="c1"># registers</span>
</span><span id="__span-6-54"><a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a><span class="n">main</span><span class="p">()</span>
</span><span id="__span-6-55"><a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a><span class="s1">&#39;</span>
</span><span id="__span-6-56"><a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="__span-6-57"><a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
</span><span id="__span-6-58"><a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">]</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">22</span><span class="p">]</span>
</span><span id="__span-6-59"><a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a><span class="mi">12</span>
</span></code></pre></div>
</details>
<p>At first glance, it looks intimidating, but in reality, it's not that complicated.
Let's break down what is happening here.
First and foremost, let's look at the new global variables.
We now have not only <code>stack</code>, but also an array <code>display</code> and a variable <code>eax</code>.
The stack's role remains unchanged, the variable <code>eax</code> emulates a processor register, and according to the x86 function call convention, I will place the return value of functions in this "register."</p>
<p>The global array <code>display</code> is more interesting.
Notice that it is not empty.
This array will not change its size; the number of its cells equals the number of different scopes in our symbol table, in this case, 3.
The idea is that with each function call, we will record the stack size in the corresponding cell,
allowing us to access the variable <code>div</code> as <code>stack[display[1]+1]</code> and the variable <code>rec</code> as <code>stack[display[2]+1]</code>.
This technique completely removes runtime dependency; each variable is always identified by the same, constant pair of numbers that we simply take from the symbol table.
Of course, when calling a function, we will need to save the old value of <code>display</code> (on the stack, where else?) and restore it upon completion.</p>
<p>Thus, the body of any function with <code>nlocals</code> local variables and <code>nargs</code> parameters will look as follows:</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">foo</span><span class="p">():</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>  <span class="k">global</span> <span class="n">display</span><span class="p">,</span><span class="n">stack</span><span class="p">,</span><span class="n">eax</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>  <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">nlocals</span>                     <span class="c1"># reserve place for local variables</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>  <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="n">scope</span><span class="p">]]</span>                   <span class="c1"># save old frame pointer</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>  <span class="n">display</span><span class="p">[</span><span class="n">scope</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">-</span><span class="n">nlocals</span><span class="o">-</span><span class="n">nargs</span><span class="o">-</span><span class="mi">1</span> <span class="c1"># set new frame pointer for foo()</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>  <span class="o">...</span>                                         <span class="c1"># function body</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>  <span class="n">display</span><span class="p">[</span><span class="n">scope</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>                <span class="c1"># restore old frame pointer</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>  <span class="n">eax</span> <span class="o">=</span> <span class="o">...</span>                                   <span class="c1"># return value</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>  <span class="k">if</span> <span class="n">nlocals</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>                               <span class="c1"># remove local variables from stack</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>    <span class="k">del</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="n">nlocals</span><span class="p">:]</span>
</span></code></pre></div>
<p>And here is a procedure for a function call:</p>
<ol>
<li>Push <code>nargs</code> values onto the stack,</li>
<li>Call the function,</li>
<li>Remove <code>nargs</code> values from the stack.</li>
</ol>
<p>I didn't randomly pick <code>sopfr</code> for nothing, I spent an entire day choosing an example.
I like it because it remains manageable for by-hand manipulation, but at the same it has as three different functions, each with a different number of parameters, a different number of local variables, and even a non-local variable.
Thus, it has three function bodies and even more different calls, allowing you to see that they are all formatted exactly the same way, using only the information available from the symbol table.</p>
<h2 id="exercise-2">Exercise 2</h2>
<p>We have rewritten the code, but its structure hasn't changed.
Let's leave the breakpoint exactly where it was before and, as an exercise, draw the state of <code>display</code> and <code>stack</code> all three times.
I won't hide the result this time; you won't remember the arrows right away anyway.
Don't cheat, draw the stack honestly; it will help you understand what and when we are saving.</p>
<p>Here is the answer:</p>
<p><a href="exercise2.png"><img alt="" src="exercise2.png" /></a></p>
<h2 id="final-stretch-evaluating-expressions">Final stretch: evaluating expressions</h2>
<p>We are now very close to assembly-like python.
The final touch is evaluating expressions.
Let's imagine we have the following program:</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">fun</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">a</span><span class="o">:</span><span class="kt">int</span><span class="p">;</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="kt">int</span><span class="p">;</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">  </span><span class="p">[...]</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">  </span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="mi">2</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">  </span><span class="p">[...]</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>Then in our symbol table, we will have one scope with identifier 0, and within it, there will be two variables with identifiers 0 and 1, respectively.
At this point, I am interested in how to evaluate the expression <code>a+b*2</code>.</p>
<p>In assembly, it will look something like this (reminder: in GNU assembler, the operators have the form <code>op src dst</code>):</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nf">mov</span><span class="w"> </span><span class="no">display</span><span class="err">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">%eax</span><span class="w">  </span><span class="c1"># find the frame of main() function</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="nf">mov</span><span class="w"> </span><span class="mi">-1</span><span class="p">(</span><span class="nv">%eax</span><span class="p">),</span><span class="w"> </span><span class="nv">%ebx</span><span class="w">   </span><span class="c1"># put b into ebx register</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="nf">mov</span><span class="w"> </span><span class="mi">-0</span><span class="p">(</span><span class="nv">%eax</span><span class="p">),</span><span class="w"> </span><span class="nv">%eax</span><span class="w">   </span><span class="c1"># put a into eax register</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="nf">imul</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nv">%ebx</span><span class="w">         </span><span class="c1"># ebx = 2 * ebx</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="nf">add</span><span class="w"> </span><span class="nv">%ebx</span><span class="p">,</span><span class="w"> </span><span class="nv">%eax</span><span class="w">       </span><span class="c1"># eax = eax + ebx</span>
</span></code></pre></div>
<p>Here I cheated a bit: in order to put <code>b</code> into <code>ebx</code>, I had to spoil the value of <code>eax</code>, so I read the argument <code>b</code> first, and then <code>a</code>.
I also cleverly put the result of <code>2*ebx</code> back into <code>ebx</code>...
And we must remember that registers are very limited, so for the expression <code>a + b * 2 - foo(c - 3, d + 10*d, bar(a/4))</code>, there will definitely not be enough registers.</p>
<p>But that's okay.
Let's remember that we are writing a compiler, and the parser has built a syntax tree of the expression for us, which looks like this:</p>
<p><img alt="" src="expr.png" /></p>
<p>Then we can generate the code to evaluate the expression by traversing the tree depth-first, using the stack to store intermediate expressions.
Imagine we agree on a very simple rule: each node of the expression saves its value in the same register,
for example, <code>%eax</code> (by the way, a function call is also an expression, and in the <code>sopfr</code> example, the function call saved its result in <code>%eax</code>).
Then the only (recursive) operation to evaluate an expression can look like this (for simplicity, I am only talking about binary operations like arithmetic):</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nf">evaluate</span><span class="w"> </span><span class="no">the</span><span class="w"> </span><span class="no">left</span><span class="w"> </span><span class="no">expression</span><span class="w"> </span><span class="p">(</span><span class="no">result</span><span class="w"> </span><span class="no">saved</span><span class="w"> </span><span class="no">in</span><span class="w"> </span><span class="nv">%eax</span><span class="p">)</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="nf">push</span><span class="p">(</span><span class="nv">%eax</span><span class="p">)</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="nf">evaluate</span><span class="w"> </span><span class="no">the</span><span class="w"> </span><span class="no">right</span><span class="w"> </span><span class="no">expression</span><span class="w"> </span><span class="p">(</span><span class="no">result</span><span class="w"> </span><span class="no">saved</span><span class="w"> </span><span class="no">in</span><span class="w"> </span><span class="nv">%eax</span><span class="p">)</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="nf">move</span><span class="w"> </span><span class="nv">%eax</span><span class="w"> </span><span class="no">to</span><span class="w"> </span><span class="nv">%ebx</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="err">%</span><span class="nf">eax</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">pop</span><span class="p">()</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="err">%</span><span class="nf">eax</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">binary</span><span class="w"> </span><span class="no">operation</span><span class="w"> </span><span class="no">on</span><span class="w"> </span><span class="nv">%eax</span><span class="w"> </span><span class="no">and</span><span class="w"> </span><span class="nv">%ebx</span>
</span></code></pre></div>
<p>Using this approach, the expression <code>a+2*b</code> can be evaluated with the following pseudocode:</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="nf">move</span><span class="w"> </span><span class="no">a</span><span class="w"> </span><span class="no">to</span><span class="w"> </span><span class="nv">%eax</span><span class="w">                       </span><span class="err">\</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="nf">push</span><span class="p">(</span><span class="nv">%eax</span><span class="p">)</span><span class="w">                            </span><span class="err">|</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="nf">move</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="no">to</span><span class="w"> </span><span class="nv">%eax</span><span class="w">      </span><span class="err">\</span><span class="w">                 </span><span class="err">|</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="nf">push</span><span class="p">(</span><span class="nv">%eax</span><span class="p">)</span><span class="w">           </span><span class="err">|</span><span class="w">                </span><span class="err">|</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="nf">move</span><span class="w"> </span><span class="no">b</span><span class="w"> </span><span class="no">to</span><span class="w"> </span><span class="nv">%eax</span><span class="w">       </span><span class="err">|</span><span class="w"> </span><span class="mi">2</span><span class="p">*</span><span class="no">b</span><span class="w"> </span><span class="no">saved</span><span class="w"> </span><span class="no">in</span><span class="w">   </span><span class="err">|</span><span class="w"> </span><span class="no">a</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">2</span><span class="p">*</span><span class="no">b</span><span class="w"> </span><span class="no">saved</span><span class="w"> </span><span class="no">in</span><span class="w"> </span><span class="nv">%eax</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="nf">move</span><span class="w"> </span><span class="nv">%eax</span><span class="w"> </span><span class="no">to</span><span class="w"> </span><span class="nv">%ebx</span><span class="w">    </span><span class="err">|</span><span class="w">    </span><span class="err">в</span><span class="w"> </span><span class="nv">%eax</span><span class="w">      </span><span class="err">|</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="err">%</span><span class="nf">eax</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">pop</span><span class="p">()</span><span class="w">         </span><span class="err">|</span><span class="w">                </span><span class="err">|</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="err">%</span><span class="nf">eax</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="nv">%eax</span><span class="w"> </span><span class="p">*</span><span class="w"> </span><span class="nv">%ebx</span><span class="w">  </span><span class="err">/</span><span class="w">                 </span><span class="err">|</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="nf">move</span><span class="w"> </span><span class="nv">%eax</span><span class="w"> </span><span class="no">to</span><span class="w"> </span><span class="nv">%ebx</span><span class="w">                     </span><span class="err">|</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="err">%</span><span class="nf">eax</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">pop</span><span class="p">()</span><span class="w">                          </span><span class="err">|</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="err">%</span><span class="nf">eax</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="nv">%eax</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="nv">%ebx</span><span class="w">                   </span><span class="err">/</span>
</span></code></pre></div>
<p>Note that the code is clearly suboptimal; it is very easy to save a lot (in fact, the assembly code I provided earlier is much simpler and does not use the stack).
But at this stage, I am not interested in optimization at all.
I need to find a general pattern for evaluating expressions, and it seems that I have found it!
We will talk about an optimizing compiler another time.</p>
<p>However, this approach has an undeniable advantage: it uses only two registers and the stack, nothing more!
So, the finishing touch on our <code>sopfr</code>: all expressions are evaluated in the <code>eax</code> register.
I still wrote the code by hand, but again, only to test the viability of the approach.
Behold the python assembly-ish code!</p>
<p><a href="sopfr3.png"><img alt="" src="sopfr3.png" /></a></p>
<p>And here it is as text:</p>
<details class="example">
<summary>assembly-ish python</summary>
<div class="language-py highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">ssloy</span><span class="nd">@khronos</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">python3</span> <span class="o">&lt;&lt;&lt;</span><span class="s1">&#39;</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">sopfr</span><span class="p">():</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">sopfr_aux</span><span class="p">():</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>            <span class="k">global</span> <span class="n">display</span><span class="p">,</span><span class="n">stack</span><span class="p">,</span><span class="n">eax</span><span class="p">,</span><span class="n">ebx</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>            <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span>         <span class="c1"># allocate memory for one local variable rec</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>            <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>     <span class="c1"># save old frame pointer</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>            <span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span> <span class="c1"># frame pointer for sopfr_aux()</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>            <span class="n">eax</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>            <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">eax</span> <span class="c1"># rec = 0</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>            <span class="n">eax</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># n</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>            <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">eax</span><span class="p">]</span>            <span class="c1"># stash left argument</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>            <span class="n">eax</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># div</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>            <span class="n">ebx</span> <span class="o">=</span> <span class="n">eax</span>                 <span class="c1"># right argument</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>            <span class="n">eax</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>         <span class="c1"># recall left arg</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>            <span class="n">eax</span> <span class="o">=</span> <span class="n">eax</span> <span class="o">%</span> <span class="n">ebx</span>           <span class="c1"># n % div</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>            <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">eax</span><span class="p">]</span>            <span class="c1"># stash left argument</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>            <span class="n">eax</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>            <span class="n">ebx</span> <span class="o">=</span> <span class="n">eax</span>                 <span class="c1"># right argument</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>            <span class="n">eax</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>         <span class="c1"># recall left arg</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>            <span class="n">eax</span> <span class="o">=</span> <span class="n">eax</span> <span class="o">==</span> <span class="n">ebx</span>          <span class="c1"># n % div == 0</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>            <span class="k">if</span> <span class="n">eax</span><span class="p">:</span>  <span class="c1"># if n % div == 0</span>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>                <span class="nb">print</span><span class="p">(</span><span class="n">display</span><span class="p">,</span><span class="n">stack</span><span class="p">)</span>  <span class="c1"># BREAKPOINT!</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>                <span class="n">eax</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># div</span>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>                <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">eax</span> <span class="c1"># rec = div</span>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>                <span class="n">eax</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># n</span>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>                <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">eax</span><span class="p">]</span>            <span class="c1"># stash left argument</span>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>                <span class="n">eax</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># div</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a>                <span class="n">ebx</span> <span class="o">=</span> <span class="n">eax</span>                 <span class="c1"># right argument</span>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a>                <span class="n">eax</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>         <span class="c1"># recall left arg</span>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a>                <span class="n">eax</span> <span class="o">=</span> <span class="n">eax</span> <span class="o">!=</span> <span class="n">ebx</span>          <span class="c1"># n != div</span>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a>                <span class="k">if</span> <span class="n">eax</span><span class="p">:</span> <span class="c1"># if n != div</span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a>                    <span class="n">eax</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># rec</span>
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a>                    <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">eax</span><span class="p">]</span>            <span class="c1"># stash left argument</span>
</span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a>                    <span class="n">eax</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># n</span>
</span><span id="__span-12-37"><a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a>                    <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">eax</span><span class="p">]</span>            <span class="c1"># stash left argument</span>
</span><span id="__span-12-38"><a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a>                    <span class="n">eax</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># div</span>
</span><span id="__span-12-39"><a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a>                    <span class="n">ebx</span> <span class="o">=</span> <span class="n">eax</span>                 <span class="c1"># right argument</span>
</span><span id="__span-12-40"><a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a>                    <span class="n">eax</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>         <span class="c1"># recall left arg</span>
</span><span id="__span-12-41"><a id="__codelineno-12-41" name="__codelineno-12-41" href="#__codelineno-12-41"></a>                    <span class="n">eax</span> <span class="o">=</span> <span class="n">eax</span> <span class="o">//</span> <span class="n">ebx</span>          <span class="c1"># n/div      ┐</span>
</span><span id="__span-12-42"><a id="__codelineno-12-42" name="__codelineno-12-42" href="#__codelineno-12-42"></a>                    <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">eax</span><span class="p">]</span>            <span class="c1">#            │ sopfr_aux(n/div)</span>
</span><span id="__span-12-43"><a id="__codelineno-12-43" name="__codelineno-12-43" href="#__codelineno-12-43"></a>                    <span class="n">sopfr_aux</span><span class="p">()</span>               <span class="c1">#            │</span>
</span><span id="__span-12-44"><a id="__codelineno-12-44" name="__codelineno-12-44" href="#__codelineno-12-44"></a>                    <span class="k">del</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>            <span class="c1">#  pop n/div ┘</span>
</span><span id="__span-12-45"><a id="__codelineno-12-45" name="__codelineno-12-45" href="#__codelineno-12-45"></a>                    <span class="n">ebx</span> <span class="o">=</span> <span class="n">eax</span>                 <span class="c1"># right argument</span>
</span><span id="__span-12-46"><a id="__codelineno-12-46" name="__codelineno-12-46" href="#__codelineno-12-46"></a>                    <span class="n">eax</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>         <span class="c1"># recall left arg</span>
</span><span id="__span-12-47"><a id="__codelineno-12-47" name="__codelineno-12-47" href="#__codelineno-12-47"></a>                    <span class="n">eax</span> <span class="o">=</span> <span class="n">eax</span> <span class="o">+</span> <span class="n">ebx</span>           <span class="c1"># rec + sopfr_aux(n/div)</span>
</span><span id="__span-12-48"><a id="__codelineno-12-48" name="__codelineno-12-48" href="#__codelineno-12-48"></a>                    <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">eax</span> <span class="c1"># rec = rec + sopfr_aux(n/div)</span>
</span><span id="__span-12-49"><a id="__codelineno-12-49" name="__codelineno-12-49" href="#__codelineno-12-49"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-12-50"><a id="__codelineno-12-50" name="__codelineno-12-50" href="#__codelineno-12-50"></a>                <span class="n">eax</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># div</span>
</span><span id="__span-12-51"><a id="__codelineno-12-51" name="__codelineno-12-51" href="#__codelineno-12-51"></a>                <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">eax</span><span class="p">]</span>            <span class="c1"># stash left argument</span>
</span><span id="__span-12-52"><a id="__codelineno-12-52" name="__codelineno-12-52" href="#__codelineno-12-52"></a>                <span class="n">eax</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="__span-12-53"><a id="__codelineno-12-53" name="__codelineno-12-53" href="#__codelineno-12-53"></a>                <span class="n">ebx</span> <span class="o">=</span> <span class="n">eax</span>                 <span class="c1"># right argument</span>
</span><span id="__span-12-54"><a id="__codelineno-12-54" name="__codelineno-12-54" href="#__codelineno-12-54"></a>                <span class="n">eax</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>         <span class="c1"># recall left arg</span>
</span><span id="__span-12-55"><a id="__codelineno-12-55" name="__codelineno-12-55" href="#__codelineno-12-55"></a>                <span class="n">eax</span> <span class="o">=</span> <span class="n">eax</span> <span class="o">+</span> <span class="n">ebx</span>           <span class="c1"># div + 1</span>
</span><span id="__span-12-56"><a id="__codelineno-12-56" name="__codelineno-12-56" href="#__codelineno-12-56"></a>                <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">eax</span> <span class="c1"># div = div + 1</span>
</span><span id="__span-12-57"><a id="__codelineno-12-57" name="__codelineno-12-57" href="#__codelineno-12-57"></a>                <span class="n">eax</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># push n ┐</span>
</span><span id="__span-12-58"><a id="__codelineno-12-58" name="__codelineno-12-58" href="#__codelineno-12-58"></a>                <span class="n">stack</span> <span class="o">+=</span><span class="p">[</span><span class="n">eax</span><span class="p">]</span>             <span class="c1">#        │ sopfr_aux(n) call</span>
</span><span id="__span-12-59"><a id="__codelineno-12-59" name="__codelineno-12-59" href="#__codelineno-12-59"></a>                <span class="n">sopfr_aux</span><span class="p">()</span>               <span class="c1">#        │</span>
</span><span id="__span-12-60"><a id="__codelineno-12-60" name="__codelineno-12-60" href="#__codelineno-12-60"></a>                <span class="k">del</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>            <span class="c1">#  pop n ┘</span>
</span><span id="__span-12-61"><a id="__codelineno-12-61" name="__codelineno-12-61" href="#__codelineno-12-61"></a>                <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">eax</span>
</span><span id="__span-12-62"><a id="__codelineno-12-62" name="__codelineno-12-62" href="#__codelineno-12-62"></a>
</span><span id="__span-12-63"><a id="__codelineno-12-63" name="__codelineno-12-63" href="#__codelineno-12-63"></a>            <span class="n">eax</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-12-64"><a id="__codelineno-12-64" name="__codelineno-12-64" href="#__codelineno-12-64"></a>            <span class="n">display</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>  <span class="c1"># restore frame pointer</span>
</span><span id="__span-12-65"><a id="__codelineno-12-65" name="__codelineno-12-65" href="#__codelineno-12-65"></a>            <span class="k">del</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>            <span class="c1"># remove rec from stack</span>
</span><span id="__span-12-66"><a id="__codelineno-12-66" name="__codelineno-12-66" href="#__codelineno-12-66"></a>
</span><span id="__span-12-67"><a id="__codelineno-12-67" name="__codelineno-12-67" href="#__codelineno-12-67"></a>        <span class="k">global</span> <span class="n">display</span><span class="p">,</span><span class="n">stack</span><span class="p">,</span><span class="n">eax</span><span class="p">,</span><span class="n">ebx</span>
</span><span id="__span-12-68"><a id="__codelineno-12-68" name="__codelineno-12-68" href="#__codelineno-12-68"></a>        <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span>         <span class="c1"># allocate memory for one local variable div</span>
</span><span id="__span-12-69"><a id="__codelineno-12-69" name="__codelineno-12-69" href="#__codelineno-12-69"></a>        <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>     <span class="c1"># save old frame pointer</span>
</span><span id="__span-12-70"><a id="__codelineno-12-70" name="__codelineno-12-70" href="#__codelineno-12-70"></a>        <span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span> <span class="c1"># frame pointer for sopfr()</span>
</span><span id="__span-12-71"><a id="__codelineno-12-71" name="__codelineno-12-71" href="#__codelineno-12-71"></a>        <span class="n">eax</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="__span-12-72"><a id="__codelineno-12-72" name="__codelineno-12-72" href="#__codelineno-12-72"></a>        <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">eax</span> <span class="c1"># div = 2</span>
</span><span id="__span-12-73"><a id="__codelineno-12-73" name="__codelineno-12-73" href="#__codelineno-12-73"></a>        <span class="n">eax</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># push n ┐</span>
</span><span id="__span-12-74"><a id="__codelineno-12-74" name="__codelineno-12-74" href="#__codelineno-12-74"></a>        <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">eax</span><span class="p">]</span>            <span class="c1">#        │ sopfr_aux(n)</span>
</span><span id="__span-12-75"><a id="__codelineno-12-75" name="__codelineno-12-75" href="#__codelineno-12-75"></a>        <span class="n">sopfr_aux</span><span class="p">()</span>               <span class="c1">#        │</span>
</span><span id="__span-12-76"><a id="__codelineno-12-76" name="__codelineno-12-76" href="#__codelineno-12-76"></a>        <span class="k">del</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>            <span class="c1">#  pop n ┘</span>
</span><span id="__span-12-77"><a id="__codelineno-12-77" name="__codelineno-12-77" href="#__codelineno-12-77"></a>        <span class="n">display</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>  <span class="c1"># restore frame pointer</span>
</span><span id="__span-12-78"><a id="__codelineno-12-78" name="__codelineno-12-78" href="#__codelineno-12-78"></a>        <span class="k">del</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>            <span class="c1"># remove div from stack</span>
</span><span id="__span-12-79"><a id="__codelineno-12-79" name="__codelineno-12-79" href="#__codelineno-12-79"></a>
</span><span id="__span-12-80"><a id="__codelineno-12-80" name="__codelineno-12-80" href="#__codelineno-12-80"></a>    <span class="k">global</span> <span class="n">display</span><span class="p">,</span><span class="n">stack</span><span class="p">,</span><span class="n">eax</span><span class="p">,</span><span class="n">ebx</span>
</span><span id="__span-12-81"><a id="__codelineno-12-81" name="__codelineno-12-81" href="#__codelineno-12-81"></a>    <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mi">0</span>           <span class="c1"># no local variables</span>
</span><span id="__span-12-82"><a id="__codelineno-12-82" name="__codelineno-12-82" href="#__codelineno-12-82"></a>    <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">display</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>       <span class="c1"># save old frame pointer</span>
</span><span id="__span-12-83"><a id="__codelineno-12-83" name="__codelineno-12-83" href="#__codelineno-12-83"></a>    <span class="n">display</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>   <span class="c1"># frame pointer for main()</span>
</span><span id="__span-12-84"><a id="__codelineno-12-84" name="__codelineno-12-84" href="#__codelineno-12-84"></a>    <span class="n">eax</span> <span class="o">=</span> <span class="mi">42</span>                    <span class="c1"># push 42 ┐</span>
</span><span id="__span-12-85"><a id="__codelineno-12-85" name="__codelineno-12-85" href="#__codelineno-12-85"></a>    <span class="n">stack</span> <span class="o">+=</span> <span class="p">[</span><span class="n">eax</span><span class="p">]</span>              <span class="c1">#         │ sopfr(42)</span>
</span><span id="__span-12-86"><a id="__codelineno-12-86" name="__codelineno-12-86" href="#__codelineno-12-86"></a>    <span class="n">sopfr</span><span class="p">()</span>                     <span class="c1">#         │</span>
</span><span id="__span-12-87"><a id="__codelineno-12-87" name="__codelineno-12-87" href="#__codelineno-12-87"></a>    <span class="k">del</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>              <span class="c1">#  pop 42 ┘</span>
</span><span id="__span-12-88"><a id="__codelineno-12-88" name="__codelineno-12-88" href="#__codelineno-12-88"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">eax</span><span class="p">)</span>
</span><span id="__span-12-89"><a id="__codelineno-12-89" name="__codelineno-12-89" href="#__codelineno-12-89"></a>    <span class="n">display</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>    <span class="c1"># restore frame pointer</span>
</span><span id="__span-12-90"><a id="__codelineno-12-90" name="__codelineno-12-90" href="#__codelineno-12-90"></a>
</span><span id="__span-12-91"><a id="__codelineno-12-91" name="__codelineno-12-91" href="#__codelineno-12-91"></a><span class="n">display</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">None</span> <span class="p">]</span><span class="o">*</span><span class="mi">3</span> <span class="c1"># uninitialized frame pointers</span>
</span><span id="__span-12-92"><a id="__codelineno-12-92" name="__codelineno-12-92" href="#__codelineno-12-92"></a><span class="n">stack</span>   <span class="o">=</span> <span class="p">[]</span>         <span class="c1"># empty stack</span>
</span><span id="__span-12-93"><a id="__codelineno-12-93" name="__codelineno-12-93" href="#__codelineno-12-93"></a><span class="n">eax</span><span class="p">,</span><span class="n">ebx</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span>  <span class="c1"># registers</span>
</span><span id="__span-12-94"><a id="__codelineno-12-94" name="__codelineno-12-94" href="#__codelineno-12-94"></a><span class="n">main</span><span class="p">()</span>
</span><span id="__span-12-95"><a id="__codelineno-12-95" name="__codelineno-12-95" href="#__codelineno-12-95"></a><span class="s1">&#39;</span>
</span><span id="__span-12-96"><a id="__codelineno-12-96" name="__codelineno-12-96" href="#__codelineno-12-96"></a><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="__span-12-97"><a id="__codelineno-12-97" name="__codelineno-12-97" href="#__codelineno-12-97"></a><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">]</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
</span><span id="__span-12-98"><a id="__codelineno-12-98" name="__codelineno-12-98" href="#__codelineno-12-98"></a><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">27</span><span class="p">]</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">]</span>
</span><span id="__span-12-99"><a id="__codelineno-12-99" name="__codelineno-12-99" href="#__codelineno-12-99"></a><span class="mi">12</span>
</span></code></pre></div>
</details>
<h2 id="summary">Summary</h2>
<p>I reiterate, the most important thing in this code is the repeatability of the same patterns for function bodies, function calls, and expression evaluation.
These patterns do not require much thought; which is perfect for automating the process.</p>
<p><a href="https://github.com/ssloy/tinycompiler/commit/0c3ba224d7e1200b0fb15166a48c6af7ac003e70">Here</a> you can see all the changes in the repository since the previous release; there are very few.
The compiler version for testing is <a href="https://github.com/ssloy/tinycompiler/releases/tag/v0.0.4">v0.0.4</a>.</p>
<p>In the end, we (almost) do not use anything from python that assembly cannot handle directly.
Virtually the only thing needed for assembly generation is to change the template for our <em>pretty printer</em>.
We will talk about this next time!</p>
<hr/>
<h3>Comments</h3>
<script src="https://giscus.app/client.js"
        data-repo="ssloy/ssloy.github.io"
        data-repo-id="R_kgDOLIjENg"
        data-category="General"
        data-category-id="DIC_kwDOLIjENs4CnFkC"
        data-mapping="pathname"
        data-strict="1"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "content.code.annotate", "content.tooltips"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>