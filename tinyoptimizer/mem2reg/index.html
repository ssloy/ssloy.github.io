
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://ssloy.github.io/tinyoptimizer/mem2reg/">
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../../tinyfloat/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>mem2reg - Playing with code</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-7F81P6F3D0"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-7F81P6F3D0",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-7F81P6F3D0",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#mem2reg" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Playing with code" class="md-header__button md-logo" aria-label="Playing with code" data-md-component="logo">
      
  <img src="../../haqreu-plate.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Playing with code
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              mem2reg
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Playing with code" class="md-nav__button md-logo" aria-label="Playing with code" data-md-component="logo">
      
  <img src="../../haqreu-plate.png" alt="logo">

    </a>
    Playing with code
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    tinyrenderer
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            tinyrenderer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/bresenham/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bresenhamâ€™s line drawing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/rasterization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Triangle rasterization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/barycentric/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Barycentric coordinates
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/z-buffer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hidden faces removal
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/camera-naive/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Naive camera handling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/camera/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Better camera
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/shading/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Shading
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/textures/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    More data!
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/tangent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tangent space
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/shadow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Shadow mapping
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/ssao/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ambient occlusion
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/toon/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bonus: toon shading
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyrenderer/afterword/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Afterword
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    tinycompiler
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            tinycompiler
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinycompiler/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinycompiler/ast/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Abstract syntax trees
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinycompiler/sly/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SLY: lexer and parser
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinycompiler/symtable/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Symbol tables
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinycompiler/display/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Displays
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinycompiler/assembly/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Assembly generation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinycompiler/lexer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DIY lexer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinycompiler/parser/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DIY parser
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinycompiler/afterword/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Afterword
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    tinyoptimizer
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            tinyoptimizer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    mem2reg
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    mem2reg
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#llvm-ir" class="md-nav__link">
    <span class="md-ellipsis">
      LLVM IR
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tinycompiler-tinyoptimizer" class="md-nav__link">
    <span class="md-ellipsis">
      TinyCompiler -&gt; TinyOptimizer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#todays-topic-mem2reg" class="md-nav__link">
    <span class="md-ellipsis">
      Today's topic: mem2reg
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lets-write-some-code" class="md-nav__link">
    <span class="md-ellipsis">
      Let's write some code
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#where-to-place-phi-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Where to place \(\phi\)-functions?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dominance-frontiers" class="md-nav__link">
    <span class="md-ellipsis">
      Dominance Frontiers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Dominance Frontiers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#definition-one" class="md-nav__link">
    <span class="md-ellipsis">
      Definition One
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#definition-two" class="md-nav__link">
    <span class="md-ellipsis">
      Definition Two
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#definition-three" class="md-nav__link">
    <span class="md-ellipsis">
      Definition Three
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#definition-four" class="md-nav__link">
    <span class="md-ellipsis">
      Definition Four
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mem2reg_1" class="md-nav__link">
    <span class="md-ellipsis">
      mem2reg
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    tinyfloat
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            tinyfloat
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyfloat/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyfloat/computers-and-numbers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Computers and Numbers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyfloat/print/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Printing floats
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tinyfloat/add/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Addition
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    strange things
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            strange things
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../strange/cursed-fire/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cursed fire or #define black magic
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#llvm-ir" class="md-nav__link">
    <span class="md-ellipsis">
      LLVM IR
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tinycompiler-tinyoptimizer" class="md-nav__link">
    <span class="md-ellipsis">
      TinyCompiler -&gt; TinyOptimizer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#todays-topic-mem2reg" class="md-nav__link">
    <span class="md-ellipsis">
      Today's topic: mem2reg
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lets-write-some-code" class="md-nav__link">
    <span class="md-ellipsis">
      Let's write some code
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#where-to-place-phi-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Where to place \(\phi\)-functions?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dominance-frontiers" class="md-nav__link">
    <span class="md-ellipsis">
      Dominance Frontiers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Dominance Frontiers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#definition-one" class="md-nav__link">
    <span class="md-ellipsis">
      Definition One
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#definition-two" class="md-nav__link">
    <span class="md-ellipsis">
      Definition Two
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#definition-three" class="md-nav__link">
    <span class="md-ellipsis">
      Definition Three
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#definition-four" class="md-nav__link">
    <span class="md-ellipsis">
      Definition Four
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mem2reg_1" class="md-nav__link">
    <span class="md-ellipsis">
      mem2reg
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="mem2reg">mem2reg</h1>
<h2 id="llvm-ir">LLVM IR</h2>
<p>Ahe compiler needs a data structure to represent code.
Currently, I use a syntax tree as an intermediate representation between <em>wend</em> and assembly.
While some optimizations are possible with this structure, there are better alternatives.</p>
<p>I have decided that LLVM IR is an excellent fit for my compiler.
My project has no external dependencies, and I do not intend to rely on LLVM.
However, having the ability to save my intermediate representation to disk and execute it using an external tool is invaluable!</p>
<p>Let's see what Clang does with the following <a href="max.c">file</a>:</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>We run <code>clang -cc1 -O0 -emit-llvm -disable-O0-optnone max.c -o max.ll</code> ant get <a href="max.ll">the following file</a>:</p>
<details class="example">
<summary>max.ll</summary>
<div class="language-llvm highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span>
<span class="normal"><a href="#__codelineno-1-19">19</a></span>
<span class="normal"><a href="#__codelineno-1-20">20</a></span>
<span class="normal"><a href="#__codelineno-1-21">21</a></span>
<span class="normal"><a href="#__codelineno-1-22">22</a></span>
<span class="normal"><a href="#__codelineno-1-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">define</span><span class="w"> </span><span class="k">dso_local</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@max</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="k">noundef</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="k">noundef</span><span class="w"> </span><span class="nv">%b</span><span class="p">)</span><span class="w"> </span><span class="vg">#0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nl">entry:</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="nv">%a.addr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="nv">%b.addr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="nv">%result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%a.addr</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%b</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%b.addr</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">  </span><span class="nv nv-Anonymous">%0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%a.addr</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%result</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">  </span><span class="nv nv-Anonymous">%1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%b.addr</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">  </span><span class="nv nv-Anonymous">%2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%a.addr</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">  </span><span class="nv">%cmp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">sgt</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">,</span><span class="w"> </span><span class="nv nv-Anonymous">%2</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%cmp</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%if.then</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%if.end</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="nl">if.then:</span><span class="w">                                          </span><span class="c">; preds = %entry</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">  </span><span class="nv nv-Anonymous">%3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%b.addr</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%3</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%result</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%if.end</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19"></a>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="nl">if.end:</span><span class="w">                                           </span><span class="c">; preds = %if.then, %entry</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">  </span><span class="nv nv-Anonymous">%4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%result</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%4</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</details>
<p>This is Clang's intermediate representation of our <code>int max(int, int)</code> function.
It can be better visualized using LLVM tools.
The following script renders all <code>.ll</code> files in the current directory:</p>
<details class="example">
<summary>draw.sh</summary>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="k">for</span><span class="w"> </span>ll<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="sb">`</span>ls<span class="w"> </span>-1<span class="w"> </span>*.ll<span class="sb">`</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span>opt<span class="w"> </span>-passes<span class="o">=</span>dot-cfg<span class="w"> </span>-disable-output<span class="w"> </span>-cfg-dot-filename-prefix<span class="o">=</span><span class="sb">`</span>basename<span class="w"> </span><span class="nv">$ll</span><span class="w"> </span>.ll<span class="sb">`</span><span class="w"> </span><span class="nv">$ll</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="k">done</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="k">for</span><span class="w"> </span>f<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="sb">`</span>ls<span class="w"> </span>-1<span class="w"> </span>*.dot<span class="sb">`</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span>dot<span class="w"> </span>-Tpng<span class="w"> </span><span class="nv">$f</span><span class="w"> </span>-O
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="k">done</span>
</span></code></pre></div>
</details>
<p>And here is our <code>int max(int, int)</code>:</p>
<p><img alt="" src="max_dot.png" /></p>
<p>In essence, this is the same intermediate code file, but here the control flow graph is explicitly visible.
LLVM intermediate code is akin to assembly code, which can be broken down into basic blocks of linear code.
Each basic block ends with a <code>br</code> branching instruction (or a simple <code>ret</code>), and they can be visualized as edges connecting basic blocks.
There are very few instruction types, making it very similar to assembly, but for a virtual machine rather than real hardware.</p>
<p>Notice that Clang has generated a completely unoptimized version of the code.
For all three variables <code>a</code>, <code>b</code>, and <code>result</code>, it allocated space on the stack using the <code>alloca</code> instruction, and every access to them is explicitly handled via <code>load</code> and <code>store</code> instructions.
Of course, this is highly inefficient, but Clang does not care, as optimizing the code is LLVMâ€™s responsibility, not Clang's.</p>
<h2 id="tinycompiler-tinyoptimizer">TinyCompiler -&gt; TinyOptimizer</h2>
<p>Well, that works fine â€” tinycompiler generates basic assembly-like code.
Since LLVM IR bytecode is not much different from assembly, I can simply switch the target language templates from GNU assembly to LLVM IR.
Since LLVM allows direct execution of its intermediate language files, I will temporarily discard assembly output and reintroduce it only after finishing optimization experiments.</p>
<p>I have no idea where this path will lead me, and I want to keep <a href="https://github.com/ssloy/tinycompiler">tinycompiler</a> minimalistic.
So, I forked it into <a href="https://github.com/ssloy/tinyoptimizer">tinyoptimizer</a>.
By the way, why on earth doesnâ€™t GitHub allow users to fork their own repositories?
I had to create a clone instead of a proper fork.</p>
<p><a href="https://github.com/ssloy/tinyoptimizer/tree/da3e700a77a7d2d261e49e06c4092e7765443cfa">Here is the commit</a> where I switched the language template.
Along the way, I made a small change: since assembly lacks variables, I previously accessed them via stack offsets.
However, LLVM IR supports proper identifiers and parameter passing (as seen in the earlier example), so why not take advantage of them?
This leaves the question of accessing variables declared outside a function.
In tinycompiler, I handled this using <a href="../../tinycompiler/display/">displays</a>, but now I simply added pointers to external variables as function parameters, and thatâ€™s it.</p>
<p>Let me provide an example.
Among my test programs, there is this one:</p>
<details class="example">
<summary>sopfr.wend</summary>
<div class="language-cpp highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span>
<span class="normal"><a href="#__codelineno-3-21">21</a></span>
<span class="normal"><a href="#__codelineno-3-22">22</a></span>
<span class="normal"><a href="#__codelineno-3-23">23</a></span>
<span class="normal"><a href="#__codelineno-3-24">24</a></span>
<span class="normal"><a href="#__codelineno-3-25">25</a></span>
<span class="normal"><a href="#__codelineno-3-26">26</a></span>
<span class="normal"><a href="#__codelineno-3-27">27</a></span>
<span class="normal"><a href="#__codelineno-3-28">28</a></span>
<span class="normal"><a href="#__codelineno-3-29">29</a></span>
<span class="normal"><a href="#__codelineno-3-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="c1">// Sum of prime factors (with repetition) of a number n.</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="c1">// E.g., 40 factors as 2^3 * 5 and sopfr(40) = 2 * 3 + 5 = 11.</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">    </span><span class="c1">// It is also known as the integer logarithm.</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">    </span><span class="c1">// https://oeis.org/A001414</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">sopfr</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">div</span><span class="p">;</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">sopfr_aux</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">recursion</span><span class="p">;</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">            </span><span class="n">recursion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">div</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">                </span><span class="n">recursion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">div</span><span class="p">;</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">n</span><span class="o">!=</span><span class="n">div</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">                    </span><span class="n">recursion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recursion</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sopfr_aux</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="n">div</span><span class="p">);</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">                </span><span class="n">div</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">div</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">                </span><span class="n">recursion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sopfr_aux</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">recursion</span><span class="p">;</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24"></a>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="w">        </span><span class="n">div</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sopfr_aux</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28"></a>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29"></a><span class="w">    </span><span class="n">println</span><span class="w"> </span><span class="nf">sopfr</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</details>
<p>For this <em>wend</em> program, I generate LLVM IR, which would have been produced by Clang from the following C equivalent:</p>
<details class="example">
<summary>sopfr.c</summary>
<div class="language-cpp highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span>
<span class="normal"><a href="#__codelineno-4-21">21</a></span>
<span class="normal"><a href="#__codelineno-4-22">22</a></span>
<span class="normal"><a href="#__codelineno-4-23">23</a></span>
<span class="normal"><a href="#__codelineno-4-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sopfr_aux</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">div</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">recursion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="o">*</span><span class="n">div</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">        </span><span class="n">recursion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">div</span><span class="p">;</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="o">!=*</span><span class="n">div</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">            </span><span class="n">recursion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recursion</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sopfr_aux</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="o">*</span><span class="n">div</span><span class="p">,</span><span class="w"> </span><span class="n">div</span><span class="p">);</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">        </span><span class="o">*</span><span class="n">div</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">div</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">        </span><span class="n">recursion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sopfr_aux</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">div</span><span class="p">);</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">recursion</span><span class="p">;</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="p">}</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16"></a>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sopfr</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">div</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sopfr_aux</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">div</span><span class="p">);</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="p">}</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21"></a>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sopfr</span><span class="p">(</span><span class="mi">42</span><span class="p">));</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</details>
<p>I convert nested functions into regular ones and pass pointers to the necessary variables.
Thus, <code>sopfr_aux</code> automatically receives a pointer to the <code>div</code> variable, which resides in the stack frame of the <code>sopfr</code> function.
Of course, I provided the C equivalent just for readability â€” I generate LLVM IR directly from <em>wend</em>.</p>
<h2 id="todays-topic-mem2reg">Today's topic: mem2reg</h2>
<p>Finally, we have reached the main topic of this article.
Today, we will explore the <code>mem2reg</code> pass.
Let's revisit the function for finding the maximum of two numbers.
Clang transforms it into the intermediate code shown on the right in the image below.
Now, let's put Clang aside and ask LLVM to improve the code slightly â€” not fully optimize it, just perform a single explicitly specified pass that promotes memory-stored variables to registers.</p>
<p><a href="max.png"><img alt="" src="max.png" /></a></p>
<p>We run <code>opt -passes=mem2reg max.ll -S</code> and obtain the transformed code shown on the left in the image.
Interestingly, all <code>alloca</code>, <code>load</code>, and <code>store</code> instructions have been completely removed, replaced by a peculiar <code>phi</code> instruction.
What exactly is this?</p>
<p>Let's take a look at <a href="https://github.com/llvm/llvm-project/blob/f451d27b387cdff14f0f45f1b3314090a5008e0c/llvm/include/llvm/IR/Instructions.h#L2608">how LLVM developers define it</a> :).</p>
<p><img alt="" src="phinode.png" /></p>
<p>LLVM intermediate code is based on the Static Single Assignment (SSA) form.
The main idea of constructing SSA form is to assign <strong>unique</strong> names to all assignment results.
Virtually all programs contain branches and merge nodes.
At merge nodes, we need to add a special form of assignment called a <span class="arithmatex">\(\phi\)</span>-function.</p>
<p>A <span class="arithmatex">\(\phi\)</span>-function is always executed at the entry of a basic block, and it has the following form:Â <span class="arithmatex">\(x \gets \phi(x_1, x_2, \dots, x_n)\)</span>Â whereÂ <span class="arithmatex">\(n\)</span>Â is the number of predecessor nodes in the control flow graph.
The semantics ofÂ <span class="arithmatex">\(\phi\)</span>-functions is simple: the value of the sourceÂ <span class="arithmatex">\(x_i\)</span>, corresponding to the blockÂ <span class="arithmatex">\(i\)</span> from which the control flow came, is selected and assigned to the variable <span class="arithmatex">\(x\)</span>.
If control flows into the block from itsÂ <span class="arithmatex">\(j\)</span>-th predecessor, thenÂ <span class="arithmatex">\(x\)</span>Â gets the valueÂ <span class="arithmatex">\(x_j\)</span>.
Once again, allÂ <span class="arithmatex">\(\phi\)</span>-functions are executedÂ beforeÂ the regular instructions in this node.</p>
<p>So, at the entry to the <code>if.end</code> block, the register <code>%result.0</code> gets the value <code>%b</code> if the control flow passes through the <code>if.then</code> block, and the value <code>%a</code> if it does not.
This results in a kind of ternary conditional operator instead of intensive stack manipulation.</p>
<p>Why are <span class="arithmatex">\(\phi\)</span>-functions necessary?
Look at the provided examples and note that in SSA form, each register is assigned a value <strong>only once</strong>.
Every time we write an instruction like <code>%a = ...</code> in SSA, it's as if in C we were only allowed to use the assignment operator for initializing constant variables like <code>const int a = ...</code>.
This does not mean that during the program execution, <code>a</code> will not hold different values.
Each basic block can be considered a small function where we declare a local constant.
By calling functions with different arguments, we get different constants <code>a</code>.
This also means that we can work locally with the block and do not have to worry about the register being redefined somewhere down the graph.
There is only one definition, and we build from it.</p>
<p>Just in case, how can we represent a loop where the counter must explicitly change? Let's take a look!</p>
<p><a href="loop.png"><img alt="" src="loop.png" /></a></p>
<p>I ran clang and then the mem2reg optimization pass on trivial counter code.
Clang placed the variable <code>i</code> on the stack and counted to ten.
LLVM, when moving variables from memory to SSA registers, removed <code>alloca</code>/<code>load</code>/<code>store</code> entirely and added a <span class="arithmatex">\(\phi\)</span>-function to <code>while.cond</code> block.
If during program execution we enter this block from the <code>entry</code> block, then <code>%i.0</code> gets the initial value.
If we enter it from the <code>while.body</code> block, then <code>%i.0</code> gets the value <code>%inc</code>.
Thus, all virtual registers have only one defining instruction, but their immediate value depends on the path taken to reach it.</p>
<p>There are several ways to deduce for this graph that <code>ret</code> always returns 10,
and that we can discard all this stuff by inlining the <code>int loop()</code> function call with the constant 10, but we will talk about this some other time.</p>
<p>In principle, these considerations can be attempted with other intermediate code representations, but SSA forms have gained the most popularity at the moment.
And the mem2reg optimization pass, which moves variables from memory to SSA registers, plays a key role in optimization.
Of course, since no assembly language has equivalents of <span class="arithmatex">\(\phi\)</span>-functions, we will eventually have to invoke the reverse pass reg2mem, replacing <span class="arithmatex">\(\phi\)</span>-functions with <code>alloca</code>/<code>store</code>/<code>load</code>.
But between mem2reg and reg2mem there will be other optimization passes, including constant propagation and much more.</p>
<h2 id="lets-write-some-code">Let's write some code</h2>
<p>I've encountered Fibonacci number calculation code so often that I've developed an aversion to it.
This is one of the reasons why I spent a lot of time on <em>wend</em> graphical demos.
However, now we will be working with intermediate code by hand, and I need it to be somewhat meaningful but extremely simple.
So, let's consider a C function that calculates Fibonacci numbers:</p>
<details class="example">
<summary>fib.c</summary>
<div class="language-cpp highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">fib</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">        </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">        </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">        </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</details>
<p>If we ask clang to generate intermediate code for it, we get this control flow graph:</p>
<p><a href="fib_dot.png"><img alt="" src="fib_dot.png" /></a></p>
<p>Let's put my compiler aside for a while and write some independent code.
What data structure can we use to represent such a control flow graph in memory? I sketched out <a href="ir.py">this file</a>:</p>
<details class="example">
<summary>ir.py</summary>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span>
<span class="normal"><a href="#__codelineno-6-29">29</a></span>
<span class="normal"><a href="#__codelineno-6-30">30</a></span>
<span class="normal"><a href="#__codelineno-6-31">31</a></span>
<span class="normal"><a href="#__codelineno-6-32">32</a></span>
<span class="normal"><a href="#__codelineno-6-33">33</a></span>
<span class="normal"><a href="#__codelineno-6-34">34</a></span>
<span class="normal"><a href="#__codelineno-6-35">35</a></span>
<span class="normal"><a href="#__codelineno-6-36">36</a></span>
<span class="normal"><a href="#__codelineno-6-37">37</a></span>
<span class="normal"><a href="#__codelineno-6-38">38</a></span>
<span class="normal"><a href="#__codelineno-6-39">39</a></span>
<span class="normal"><a href="#__codelineno-6-40">40</a></span>
<span class="normal"><a href="#__codelineno-6-41">41</a></span>
<span class="normal"><a href="#__codelineno-6-42">42</a></span>
<span class="normal"><a href="#__codelineno-6-43">43</a></span>
<span class="normal"><a href="#__codelineno-6-44">44</a></span>
<span class="normal"><a href="#__codelineno-6-45">45</a></span>
<span class="normal"><a href="#__codelineno-6-46">46</a></span>
<span class="normal"><a href="#__codelineno-6-47">47</a></span>
<span class="normal"><a href="#__codelineno-6-48">48</a></span>
<span class="normal"><a href="#__codelineno-6-49">49</a></span>
<span class="normal"><a href="#__codelineno-6-50">50</a></span>
<span class="normal"><a href="#__codelineno-6-51">51</a></span>
<span class="normal"><a href="#__codelineno-6-52">52</a></span>
<span class="normal"><a href="#__codelineno-6-53">53</a></span>
<span class="normal"><a href="#__codelineno-6-54">54</a></span>
<span class="normal"><a href="#__codelineno-6-55">55</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Instruction</span><span class="p">:</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">string</span><span class="p">,</span> <span class="n">args</span> <span class="c1"># string and parameters (typically three)</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">)</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7"></a>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">Phi</span><span class="p">:</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">choice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">choice</span> <span class="o">=</span> <span class="n">reg</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">choice</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11"></a>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13"></a>        <span class="n">choice</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span> <span class="s1">&#39;[</span><span class="si">{percent}{value}</span><span class="s1">, %</span><span class="si">{block}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percent</span> <span class="o">=</span> <span class="s1">&#39;%&#39;</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">)</span> <span class="k">for</span> <span class="n">block</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">choice</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">])</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;%</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="si">}</span><span class="s1"> = phi </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">choice</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15"></a>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="k">class</span><span class="w"> </span><span class="nc">BasicBlock</span><span class="p">:</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">phi_functions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span>  <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">successors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">predecessors</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21"></a>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_and_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">find</span><span class="p">,</span> <span class="n">replace</span><span class="p">):</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">:</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24"></a>            <span class="n">i</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span> <span class="n">replace</span> <span class="k">if</span> <span class="n">s</span><span class="o">==</span><span class="n">find</span> <span class="k">else</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">op</span> <span class="p">)</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25"></a>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28"></a>                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">phi</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">phi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_functions</span> <span class="p">])</span> <span class="o">+</span> \
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29"></a>                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>   <span class="k">for</span> <span class="n">i</span>   <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span>  <span class="p">])</span>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30"></a>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31"></a><span class="k">class</span><span class="w"> </span><span class="nc">ControlFlowGraph</span><span class="p">:</span>                  <span class="c1"># a control flow graph is made of basic blocks and</span>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">footer</span><span class="p">):</span>  <span class="c1"># header + footer strings to form a valid LLVM IR program</span>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">footer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last</span> <span class="o">=</span> <span class="n">header</span><span class="p">,</span> <span class="n">footer</span><span class="p">,</span> <span class="p">{},</span> <span class="kc">None</span>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34"></a>
</span><span id="__span-6-35"><a id="__codelineno-6-35" name="__codelineno-6-35"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
</span><span id="__span-6-36"><a id="__codelineno-6-36" name="__codelineno-6-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">BasicBlock</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="__span-6-37"><a id="__codelineno-6-37" name="__codelineno-6-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>   <span class="c1"># the last block added to the CFG, heavily used by the IR builder</span>
</span><span id="__span-6-38"><a id="__codelineno-6-38" name="__codelineno-6-38"></a>
</span><span id="__span-6-39"><a id="__codelineno-6-39" name="__codelineno-6-39"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-6-40"><a id="__codelineno-6-40" name="__codelineno-6-40"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
</span><span id="__span-6-41"><a id="__codelineno-6-41" name="__codelineno-6-41"></a>               <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">block</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="p">])</span> <span class="o">+</span> \
</span><span id="__span-6-42"><a id="__codelineno-6-42" name="__codelineno-6-42"></a>               <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">footer</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="__span-6-43"><a id="__codelineno-6-43" name="__codelineno-6-43"></a>
</span><span id="__span-6-44"><a id="__codelineno-6-44" name="__codelineno-6-44"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_and_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">find</span><span class="p">,</span> <span class="n">replace</span><span class="p">):</span>
</span><span id="__span-6-45"><a id="__codelineno-6-45" name="__codelineno-6-45"></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="__span-6-46"><a id="__codelineno-6-46" name="__codelineno-6-46"></a>            <span class="n">b</span><span class="o">.</span><span class="n">find_and_replace</span><span class="p">(</span><span class="n">find</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span>
</span><span id="__span-6-47"><a id="__codelineno-6-47" name="__codelineno-6-47"></a>
</span><span id="__span-6-48"><a id="__codelineno-6-48" name="__codelineno-6-48"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_adjacency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-6-49"><a id="__codelineno-6-49" name="__codelineno-6-49"></a>        <span class="k">for</span> <span class="n">b1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="__span-6-50"><a id="__codelineno-6-50" name="__codelineno-6-50"></a>            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="s1">&#39;unreachable&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">string</span> <span class="ow">or</span> <span class="s1">&#39;ret &#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">string</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">b1</span><span class="o">.</span><span class="n">instructions</span><span class="p">):</span>
</span><span id="__span-6-51"><a id="__codelineno-6-51" name="__codelineno-6-51"></a>                <span class="k">continue</span> <span class="c1"># even if there is a br instruction later on in the block, there are no outgoing edges</span>
</span><span id="__span-6-52"><a id="__codelineno-6-52" name="__codelineno-6-52"></a>            <span class="k">for</span> <span class="n">succ</span> <span class="ow">in</span> <span class="n">b1</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">op</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="s1">&#39;br i1&#39;</span> <span class="ow">in</span> <span class="n">b1</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">string</span><span class="p">):]:</span>
</span><span id="__span-6-53"><a id="__codelineno-6-53" name="__codelineno-6-53"></a>                <span class="n">b2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">succ</span><span class="p">]</span>
</span><span id="__span-6-54"><a id="__codelineno-6-54" name="__codelineno-6-54"></a>                <span class="n">b1</span><span class="o">.</span><span class="n">successors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b2</span><span class="p">)</span>
</span><span id="__span-6-55"><a id="__codelineno-6-55" name="__codelineno-6-55"></a>                <span class="n">b2</span><span class="o">.</span><span class="n">predecessors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
</details>
<p>These 55 lines allow me to manipulate intermediate code.
I have a class <code>ControlFlowGraph</code>, which is simply a list of objects <code>BasicBlock</code>.
Each basic block is just a list of <span class="arithmatex">\(\phi\)</span>-functions and regular instructions,
as well as a list of links to the predecessors and successors of this block.
Predecessors and successors are initially empty but are filled (<code>compute_adjacency()</code>) based on branching instructions.
Each instruction is a fairly arbitrary string and a list of constants and register names involved in it.</p>
<p>I took the intermediate code of the <code>int fib(int)</code> function generated by clang and manually entered it into <a href="fib.py">my program</a>:</p>
<details class="example">
<summary>fib.py</summary>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span>
<span class="normal"><a href="#__codelineno-7-20">20</a></span>
<span class="normal"><a href="#__codelineno-7-21">21</a></span>
<span class="normal"><a href="#__codelineno-7-22">22</a></span>
<span class="normal"><a href="#__codelineno-7-23">23</a></span>
<span class="normal"><a href="#__codelineno-7-24">24</a></span>
<span class="normal"><a href="#__codelineno-7-25">25</a></span>
<span class="normal"><a href="#__codelineno-7-26">26</a></span>
<span class="normal"><a href="#__codelineno-7-27">27</a></span>
<span class="normal"><a href="#__codelineno-7-28">28</a></span>
<span class="normal"><a href="#__codelineno-7-29">29</a></span>
<span class="normal"><a href="#__codelineno-7-30">30</a></span>
<span class="normal"><a href="#__codelineno-7-31">31</a></span>
<span class="normal"><a href="#__codelineno-7-32">32</a></span>
<span class="normal"><a href="#__codelineno-7-33">33</a></span>
<span class="normal"><a href="#__codelineno-7-34">34</a></span>
<span class="normal"><a href="#__codelineno-7-35">35</a></span>
<span class="normal"><a href="#__codelineno-7-36">36</a></span>
<span class="normal"><a href="#__codelineno-7-37">37</a></span>
<span class="normal"><a href="#__codelineno-7-38">38</a></span>
<span class="normal"><a href="#__codelineno-7-39">39</a></span>
<span class="normal"><a href="#__codelineno-7-40">40</a></span>
<span class="normal"><a href="#__codelineno-7-41">41</a></span>
<span class="normal"><a href="#__codelineno-7-42">42</a></span>
<span class="normal"><a href="#__codelineno-7-43">43</a></span>
<span class="normal"><a href="#__codelineno-7-44">44</a></span>
<span class="normal"><a href="#__codelineno-7-45">45</a></span>
<span class="normal"><a href="#__codelineno-7-46">46</a></span>
<span class="normal"><a href="#__codelineno-7-47">47</a></span>
<span class="normal"><a href="#__codelineno-7-48">48</a></span>
<span class="normal"><a href="#__codelineno-7-49">49</a></span>
<span class="normal"><a href="#__codelineno-7-50">50</a></span>
<span class="normal"><a href="#__codelineno-7-51">51</a></span>
<span class="normal"><a href="#__codelineno-7-52">52</a></span>
<span class="normal"><a href="#__codelineno-7-53">53</a></span>
<span class="normal"><a href="#__codelineno-7-54">54</a></span>
<span class="normal"><a href="#__codelineno-7-55">55</a></span>
<span class="normal"><a href="#__codelineno-7-56">56</a></span>
<span class="normal"><a href="#__codelineno-7-57">57</a></span>
<span class="normal"><a href="#__codelineno-7-58">58</a></span>
<span class="normal"><a href="#__codelineno-7-59">59</a></span>
<span class="normal"><a href="#__codelineno-7-60">60</a></span>
<span class="normal"><a href="#__codelineno-7-61">61</a></span>
<span class="normal"><a href="#__codelineno-7-62">62</a></span>
<span class="normal"><a href="#__codelineno-7-63">63</a></span>
<span class="normal"><a href="#__codelineno-7-64">64</a></span>
<span class="normal"><a href="#__codelineno-7-65">65</a></span>
<span class="normal"><a href="#__codelineno-7-66">66</a></span>
<span class="normal"><a href="#__codelineno-7-67">67</a></span>
<span class="normal"><a href="#__codelineno-7-68">68</a></span>
<span class="normal"><a href="#__codelineno-7-69">69</a></span>
<span class="normal"><a href="#__codelineno-7-70">70</a></span>
<span class="normal"><a href="#__codelineno-7-71">71</a></span>
<span class="normal"><a href="#__codelineno-7-72">72</a></span>
<span class="normal"><a href="#__codelineno-7-73">73</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ir</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="n">cfg</span> <span class="o">=</span> <span class="n">ControlFlowGraph</span><span class="p">(</span><span class="s1">&#39;define i32 @fib(i32 %n) {&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">)</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="n">cfg</span><span class="o">.</span><span class="n">add_block</span><span class="p">(</span><span class="s1">&#39;entry&#39;</span><span class="p">)</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="n">cfg</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">instructions</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{op[0]}</span><span class="s1"> = alloca i32&#39;</span><span class="p">,</span> <span class="s1">&#39;retval&#39;</span><span class="p">),</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{op[0]}</span><span class="s1"> = alloca i32&#39;</span><span class="p">,</span> <span class="s1">&#39;n.addr&#39;</span><span class="p">),</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{op[0]}</span><span class="s1"> = alloca i32&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">),</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{op[0]}</span><span class="s1"> = alloca i32&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">),</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{op[0]}</span><span class="s1"> = alloca i32&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">),</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{op[0]}</span><span class="s1"> = alloca i32&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">),</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;store i32 %</span><span class="si">{op[0]}</span><span class="s1">, ptr %</span><span class="si">{op[1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;n.addr&#39;</span><span class="p">),</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;store i32 </span><span class="si">{op[0]}</span><span class="s1">, ptr %</span><span class="si">{op[1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">),</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;store i32 </span><span class="si">{op[0]}</span><span class="s1">, ptr %</span><span class="si">{op[1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">),</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;store i32 </span><span class="si">{op[0]}</span><span class="s1">, ptr %</span><span class="si">{op[1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">),</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;store i32 </span><span class="si">{op[0]}</span><span class="s1">, ptr %</span><span class="si">{op[1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">),</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{op[0]}</span><span class="s1"> = load i32, ptr %</span><span class="si">{op[1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;n.addr&#39;</span><span class="p">),</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{op[0]}</span><span class="s1"> = icmp eq i32 %</span><span class="si">{op[1]}</span><span class="s1">, </span><span class="si">{op[2]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;cmp&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;br i1 %</span><span class="si">{op[0]}</span><span class="s1">, label %</span><span class="si">{op[1]}</span><span class="s1">, label %</span><span class="si">{op[2]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;cmp&#39;</span><span class="p">,</span> <span class="s1">&#39;if.then&#39;</span><span class="p">,</span> <span class="s1">&#39;if.end&#39;</span><span class="p">)</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="p">]</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20"></a>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="n">cfg</span><span class="o">.</span><span class="n">add_block</span><span class="p">(</span><span class="s1">&#39;if.then&#39;</span><span class="p">)</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="n">cfg</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">instructions</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;store i32 </span><span class="si">{op[0]}</span><span class="s1">, ptr %</span><span class="si">{op[1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;retval&#39;</span><span class="p">),</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;br label %</span><span class="si">{op[0]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">)</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25"></a><span class="p">]</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26"></a>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27"></a><span class="n">cfg</span><span class="o">.</span><span class="n">add_block</span><span class="p">(</span><span class="s1">&#39;if.end&#39;</span><span class="p">)</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28"></a><span class="n">cfg</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">instructions</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;br label %</span><span class="si">{op[0]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;while.cond&#39;</span><span class="p">)</span>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30"></a><span class="p">]</span>
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31"></a>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32"></a><span class="n">cfg</span><span class="o">.</span><span class="n">add_block</span><span class="p">(</span><span class="s1">&#39;while.cond&#39;</span><span class="p">)</span>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33"></a><span class="n">cfg</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">instructions</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{op[0]}</span><span class="s1"> = load i32, ptr %</span><span class="si">{op[1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">),</span>
</span><span id="__span-7-35"><a id="__codelineno-7-35" name="__codelineno-7-35"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{op[0]}</span><span class="s1"> = load i32, ptr %</span><span class="si">{op[1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;n.addr&#39;</span><span class="p">),</span>
</span><span id="__span-7-36"><a id="__codelineno-7-36" name="__codelineno-7-36"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{op[0]}</span><span class="s1"> = icmp slt i32 %</span><span class="si">{op[1]}</span><span class="s1">, %</span><span class="si">{op[2]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;cmp1&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">),</span>
</span><span id="__span-7-37"><a id="__codelineno-7-37" name="__codelineno-7-37"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;br i1 %</span><span class="si">{op[0]}</span><span class="s1">, label %</span><span class="si">{op[1]}</span><span class="s1">, label %</span><span class="si">{op[2]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;cmp1&#39;</span><span class="p">,</span> <span class="s1">&#39;while.body&#39;</span><span class="p">,</span> <span class="s1">&#39;while.end&#39;</span><span class="p">)</span>
</span><span id="__span-7-38"><a id="__codelineno-7-38" name="__codelineno-7-38"></a><span class="p">]</span>
</span><span id="__span-7-39"><a id="__codelineno-7-39" name="__codelineno-7-39"></a>
</span><span id="__span-7-40"><a id="__codelineno-7-40" name="__codelineno-7-40"></a><span class="n">cfg</span><span class="o">.</span><span class="n">add_block</span><span class="p">(</span><span class="s1">&#39;while.body&#39;</span><span class="p">)</span>
</span><span id="__span-7-41"><a id="__codelineno-7-41" name="__codelineno-7-41"></a><span class="n">cfg</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">instructions</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-7-42"><a id="__codelineno-7-42" name="__codelineno-7-42"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{op[0]}</span><span class="s1"> = load i32, ptr %</span><span class="si">{op[1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">),</span>
</span><span id="__span-7-43"><a id="__codelineno-7-43" name="__codelineno-7-43"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;store i32 %</span><span class="si">{op[0]}</span><span class="s1">, ptr %</span><span class="si">{op[1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">),</span>
</span><span id="__span-7-44"><a id="__codelineno-7-44" name="__codelineno-7-44"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{op[0]}</span><span class="s1"> = load i32, ptr %</span><span class="si">{op[1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">),</span>
</span><span id="__span-7-45"><a id="__codelineno-7-45" name="__codelineno-7-45"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{op[0]}</span><span class="s1"> = load i32, ptr %</span><span class="si">{op[1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">),</span>
</span><span id="__span-7-46"><a id="__codelineno-7-46" name="__codelineno-7-46"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{op[0]}</span><span class="s1"> = add i32 %</span><span class="si">{op[1]}</span><span class="s1">, %</span><span class="si">{op[2]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">),</span>
</span><span id="__span-7-47"><a id="__codelineno-7-47" name="__codelineno-7-47"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;store i32 %</span><span class="si">{op[0]}</span><span class="s1">, ptr %</span><span class="si">{op[1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">),</span>
</span><span id="__span-7-48"><a id="__codelineno-7-48" name="__codelineno-7-48"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{op[0]}</span><span class="s1"> = load i32, ptr %</span><span class="si">{op[1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">),</span>
</span><span id="__span-7-49"><a id="__codelineno-7-49" name="__codelineno-7-49"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;store i32 %</span><span class="si">{op[0]}</span><span class="s1">, ptr %</span><span class="si">{op[1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">),</span>
</span><span id="__span-7-50"><a id="__codelineno-7-50" name="__codelineno-7-50"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{op[0]}</span><span class="s1"> = load i32, ptr %</span><span class="si">{op[1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">),</span>
</span><span id="__span-7-51"><a id="__codelineno-7-51" name="__codelineno-7-51"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{op[0]}</span><span class="s1"> = add i32 %</span><span class="si">{op[1]}</span><span class="s1">, </span><span class="si">{op[2]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;add2&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="__span-7-52"><a id="__codelineno-7-52" name="__codelineno-7-52"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;store i32 %</span><span class="si">{op[0]}</span><span class="s1">, ptr %</span><span class="si">{op[1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;add2&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">),</span>
</span><span id="__span-7-53"><a id="__codelineno-7-53" name="__codelineno-7-53"></a>
</span><span id="__span-7-54"><a id="__codelineno-7-54" name="__codelineno-7-54"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;br label %</span><span class="si">{op[0]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;while.cond&#39;</span><span class="p">)</span>
</span><span id="__span-7-55"><a id="__codelineno-7-55" name="__codelineno-7-55"></a><span class="p">]</span>
</span><span id="__span-7-56"><a id="__codelineno-7-56" name="__codelineno-7-56"></a>
</span><span id="__span-7-57"><a id="__codelineno-7-57" name="__codelineno-7-57"></a><span class="n">cfg</span><span class="o">.</span><span class="n">add_block</span><span class="p">(</span><span class="s1">&#39;while.end&#39;</span><span class="p">)</span>
</span><span id="__span-7-58"><a id="__codelineno-7-58" name="__codelineno-7-58"></a><span class="n">cfg</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">instructions</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-7-59"><a id="__codelineno-7-59" name="__codelineno-7-59"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{op[0]}</span><span class="s1"> = load i32, ptr %</span><span class="si">{op[1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">),</span>
</span><span id="__span-7-60"><a id="__codelineno-7-60" name="__codelineno-7-60"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;store i32 %</span><span class="si">{op[0]}</span><span class="s1">, ptr %</span><span class="si">{op[1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;retval&#39;</span><span class="p">),</span>
</span><span id="__span-7-61"><a id="__codelineno-7-61" name="__codelineno-7-61"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;br label %</span><span class="si">{op[0]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">)</span>
</span><span id="__span-7-62"><a id="__codelineno-7-62" name="__codelineno-7-62"></a><span class="p">]</span>
</span><span id="__span-7-63"><a id="__codelineno-7-63" name="__codelineno-7-63"></a>
</span><span id="__span-7-64"><a id="__codelineno-7-64" name="__codelineno-7-64"></a><span class="n">cfg</span><span class="o">.</span><span class="n">add_block</span><span class="p">(</span><span class="s1">&#39;return&#39;</span><span class="p">)</span>
</span><span id="__span-7-65"><a id="__codelineno-7-65" name="__codelineno-7-65"></a><span class="n">cfg</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">instructions</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-7-66"><a id="__codelineno-7-66" name="__codelineno-7-66"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{op[0]}</span><span class="s1"> = load i32, ptr %</span><span class="si">{op[1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">,</span> <span class="s1">&#39;retval&#39;</span><span class="p">),</span>
</span><span id="__span-7-67"><a id="__codelineno-7-67" name="__codelineno-7-67"></a>    <span class="n">Instruction</span><span class="p">(</span><span class="s1">&#39;ret i32 %</span><span class="si">{op[0]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">)</span>
</span><span id="__span-7-68"><a id="__codelineno-7-68" name="__codelineno-7-68"></a><span class="p">]</span>
</span><span id="__span-7-69"><a id="__codelineno-7-69" name="__codelineno-7-69"></a><span class="n">cfg</span><span class="o">.</span><span class="n">compute_adjacency</span><span class="p">()</span>
</span><span id="__span-7-70"><a id="__codelineno-7-70" name="__codelineno-7-70"></a>
</span><span id="__span-7-71"><a id="__codelineno-7-71" name="__codelineno-7-71"></a><span class="hll"><span class="c1">#from optimizer import *</span>
</span></span><span id="__span-7-72"><a id="__codelineno-7-72" name="__codelineno-7-72"></a><span class="hll"><span class="c1">#mem2reg(cfg)</span>
</span></span><span id="__span-7-73"><a id="__codelineno-7-73" name="__codelineno-7-73"></a><span class="nb">print</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
</details>
<p>The output of this Python script matches the intermediate code generated by clang (well, up to some attributes that I don't need),
and it compiles/draws the same way using llvm.
Note the commented lines 71-72.
Our job for today is to uncomment them ;)</p>
<h2 id="where-to-place-phi-functions">Where to place <span class="arithmatex">\(\phi\)</span>-functions?</h2>
<p>We have put aside the compiler and written 55+69 lines of Python to manipulate a single Fibonacci numbers example.
It uses only local variables and nowhere takes their addresses, so we can safely discard all <code>alloca</code>.</p>
<p>Next, we need to remove all <code>store</code>/<code>load</code> instructions, replacing them with <span class="arithmatex">\(\phi\)</span>-functions in the necessary places.
And where are those necessary places?</p>
<details class="hint">
<summary>Hint</summary>
<p>In principle, there is a rather brute-force method: at the entry of <strong>each block</strong> (well, except for the entry block), insert a <strong><span class="arithmatex">\(\phi\)</span>-function for each variable</strong>.
Yes, even in blocks with only one predecessor!</p>
<p>This is called the maximal SSA form, and this approach is usually criticized for creating too many redundant <span class="arithmatex">\(\phi\)</span>-functions,
slowing down compilation (I don't care) and complicates optimization.
On the other hand, I strongly suspect that a regular DCE (dead code elimination) pass will clean up the junk completely.
When I get to DCE in tinyoptimizer, I should try to calculate the maximal SSA form, it might be simpler.</p>
<p>Remember "premature optimization is the root of all evil"...</p>
</details>
<p>Let's start with a fairly obvious reasoning (here and below I am working with the last example): in the <code>if.then</code> block, there is a <code>store</code> instruction <code>i32 0, ptr %retval</code>,
which writes the value 0 to the memory at the address <code>%retval</code>.
Also, in the <code>return</code> block, there is an instruction <code>%9 = load i32, ptr %retval</code>, which obviously reads memory from the same address <code>%retval</code> into the register <code>%9</code>.</p>
<p>But we can reach the <code>return</code> block without passing through the <code>if.then</code> block! For each <code>store</code> instruction, we need to insert a <span class="arithmatex">\(\phi\)</span>-function in the following case:</p>
<ol>
<li>If there is a path from the entry point of the graph that passes through the block with the <code>store</code> and reaches the block with the <code>load</code>,</li>
<li>And if there is another path from the entry point of the graph that reaches the block with the same <code>load</code> without passing through our <code>store</code>.</li>
</ol>
<p>It is quite obvious that somewhere these two paths converge before reaching the <code>load</code>, and at this merge point, we need a <span class="arithmatex">\(\phi\)</span>-function for our variable <code>%retval</code>.</p>
<p>The basic block where our two paths through the graph converge is one of the elements of the dominance frontier of the block containing the <code>store</code> instruction.
And here we need a bit of technical vocabulary.</p>
<h2 id="dominance-frontiers">Dominance Frontiers</h2>
<h3 id="definition-one">Definition One</h3>
<p>Block <code>A</code> dominates block <code>B</code> if and only if every path from the start of the graph to block <code>B</code> goes through node <code>A</code>.</p>
<p>It is quite obvious that every basic block dominates itself, and, for example,
there are only two blocks that dominate the <code>return</code> block, since only <code>entry</code> and <code>return</code> appear on all possible paths, they are the dominators for <code>return</code>.</p>
<p>Try drawing the graph on paper and determine the set of dominating blocks for each node in the graph.
Just in case, so you don't have to scroll back too far, here is the graph again:</p>
<p><img alt="" src="dominators.png" /></p>
<p>Let's synchronize our watches, here is the list of dominators for each block:
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>{
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>    entry:      {entry},
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    if.then:    {if.then, entry},
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>    if.end:     {if.end, entry},
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    while.cond: {if.end, while.cond, entry},
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>    while.body: {while.body, if.end, while.cond, entry},
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>    while.end:  {while.end, if.end, while.cond, entry},
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>    return:     {return, entry}
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>}
</span></code></pre></div></p>
<h3 id="definition-two">Definition Two</h3>
<p>Block <code>A</code> strictly dominates block <code>B</code> if <code>A</code> dominates <code>B</code> but is not equal to it.
Here are the sets of strict dominators for each basic block in our program:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>{
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>    entry:      {},
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    if.then:    {entry},
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    if.end:     {entry},
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    while.cond: {if.end, entry},
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>    while.body: {if.end, while.cond, entry},
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>    while.end:  {if.end, while.cond, entry},
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>    return:     {entry}
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>}
</span></code></pre></div>
<h3 id="definition-three">Definition Three</h3>
<p><code>A</code> is the immediate dominator of <code>B</code> if <code>A</code> strictly dominates <code>B</code> but no other strict dominator of <code>B</code> strictly dominates <code>A</code>.</p>
<p>WAIT, WHAT?</p>
<p>Let's break it down.
Each node has a set of strict dominators, right? Well, except for the start node.
So, we take the closest one and call it the immediate dominator.
Here is the list of immediate dominators for each of our basic blocks:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>{
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>    entry:      None,
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>    if.then:    entry,
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    if.end:     entry,
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>    while.cond: if.end,
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>    while.end:  while.cond,
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>    return:     entry,
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>    while.body: while.cond
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>}
</span></code></pre></div>
<p>This information can also be visualized in the form of a tree called a dominance tree:</p>
<p><img alt="" src="dominance_tree.png" /></p>
<p>Note that the edges of the dominance tree are not necessarily the edges of the original graph.</p>
<h3 id="definition-four">Definition Four</h3>
<p>The dominance frontier of node <code>A</code> is the set of nodes <code>B</code> such that:</p>
<ol>
<li><code>A</code> dominates at least one of their predecessors.</li>
<li><code>A</code> does not strictly dominate the node <code>B</code> itself.</li>
</ol>
<p>In other words, the dominance frontier of node <code>A</code> consists of nodes where the dominance of <code>A</code> ends: these nodes can be reached through both <code>A</code> and alternative paths that do not pass through <code>A</code>.</p>
<p>If a node in your control flow graph has fewer than two predecessors,
it will not be in the dominance frontier of any node, as it cannot be a merge point of competing definitions.
The concept of the "dominance frontier" is that these are precisely the nodes where the dominance of a node ends.
You can also say that the frontier includes all nodes that have edges coming from the dominance subtree.</p>
<p>The dominance frontier shows places in the CFG where different control flows converge.
Frontier nodes are places where different versions of the same variable may meet, and therefore <span class="arithmatex">\(\phi\)</span>-functions need to be inserted there.</p>
<p>Let's synchronize our watches, here is the set of nodes in the dominance frontier for each node:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>{
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>    entry:      {}
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    if.then:    {return}
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    return:     {}
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>    while.body: {while.cond}
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>    if.end:     {return}
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>    while.end:  {return}
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>    while.cond: {return, while.cond}
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>}
</span></code></pre></div>
<p>Let's return to our <code>store</code> operation inside the <code>if.then</code> block.
The <code>return</code> block is in the dominance frontier of <code>if.then</code>, so we need to insert a <span class="arithmatex">\(\phi\)</span>-function there.
It all seems to match up.
By the way, note that <code>while.cond</code> is in its own frontier.
This is completely normal, no need to worry.
But it should be noted that we have a <code>load</code> of the variable <code>%i</code> in the <code>while.cond</code> block, which we can reach either from the <code>if.end</code> block or from the <code>while.body</code> block.
So we will need <span class="arithmatex">\(\phi\)</span>-functions there as well.</p>
<p>Okay, we have understood the definition of dominance frontiers and can find them manually, but it would be nice to program it.
Here are 43 lines of Python that allow us to find the frontiers for each node in the CFG.</p>
<details class="example">
<summary>Optimizer</summary>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span>
<span class="normal"><a href="#__codelineno-12-14">14</a></span>
<span class="normal"><a href="#__codelineno-12-15">15</a></span>
<span class="normal"><a href="#__codelineno-12-16">16</a></span>
<span class="normal"><a href="#__codelineno-12-17">17</a></span>
<span class="normal"><a href="#__codelineno-12-18">18</a></span>
<span class="normal"><a href="#__codelineno-12-19">19</a></span>
<span class="normal"><a href="#__codelineno-12-20">20</a></span>
<span class="normal"><a href="#__codelineno-12-21">21</a></span>
<span class="normal"><a href="#__codelineno-12-22">22</a></span>
<span class="normal"><a href="#__codelineno-12-23">23</a></span>
<span class="normal"><a href="#__codelineno-12-24">24</a></span>
<span class="normal"><a href="#__codelineno-12-25">25</a></span>
<span class="normal"><a href="#__codelineno-12-26">26</a></span>
<span class="normal"><a href="#__codelineno-12-27">27</a></span>
<span class="normal"><a href="#__codelineno-12-28">28</a></span>
<span class="normal"><a href="#__codelineno-12-29">29</a></span>
<span class="normal"><a href="#__codelineno-12-30">30</a></span>
<span class="normal"><a href="#__codelineno-12-31">31</a></span>
<span class="normal"><a href="#__codelineno-12-32">32</a></span>
<span class="normal"><a href="#__codelineno-12-33">33</a></span>
<span class="normal"><a href="#__codelineno-12-34">34</a></span>
<span class="normal"><a href="#__codelineno-12-35">35</a></span>
<span class="normal"><a href="#__codelineno-12-36">36</a></span>
<span class="normal"><a href="#__codelineno-12-37">37</a></span>
<span class="normal"><a href="#__codelineno-12-38">38</a></span>
<span class="normal"><a href="#__codelineno-12-39">39</a></span>
<span class="normal"><a href="#__codelineno-12-40">40</a></span>
<span class="normal"><a href="#__codelineno-12-41">41</a></span>
<span class="normal"><a href="#__codelineno-12-42">42</a></span>
<span class="normal"><a href="#__codelineno-12-43">43</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ir</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">Optimizer</span><span class="p">:</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">):</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="s1">&#39;entry&#39;</span><span class="p">]</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reachable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">postorder</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(),</span> <span class="p">[]</span>  <span class="c1"># for efficiency reasons, we visit blocks in a way that ensures</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entry</span><span class="p">)</span>                        <span class="c1"># processing of each block after its predecessors have been processed</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8"></a>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">):</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reachable</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11"></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">successors</span><span class="p">:</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12"></a>            <span class="k">if</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reachable</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfs</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">postorder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14"></a>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dominators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                       <span class="c1"># the iterative dominator algorithm [Cooper, Harvey and Kennedy, 2006]</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16"></a>        <span class="n">dom</span> <span class="o">=</span> <span class="p">{</span> <span class="n">b</span> <span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="p">}</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17"></a>        <span class="n">dom</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry</span> <span class="p">}</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18"></a>        <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19"></a>        <span class="k">while</span> <span class="n">changed</span><span class="p">:</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20"></a>            <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21"></a>            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">postorder</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>    <span class="c1"># for all blocks (except the source) in reverse postorder</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22"></a>                <span class="n">new_dom</span> <span class="o">=</span> <span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="p">[</span> <span class="n">dom</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">predecessors</span> <span class="p">])</span> <span class="o">|</span> <span class="p">{</span> <span class="n">b</span> <span class="p">}</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23"></a>                <span class="n">changed</span> <span class="o">=</span> <span class="n">dom</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">!=</span> <span class="n">new_dom</span>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24"></a>                <span class="n">dom</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>  <span class="o">=</span> <span class="n">new_dom</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25"></a>        <span class="k">return</span> <span class="n">dom</span>                              <span class="c1"># dom[b] contains every block that dominates b</span>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26"></a>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">immediate_dominators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28"></a>        <span class="n">dom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dominators</span><span class="p">()</span>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29"></a>        <span class="n">idom</span> <span class="o">=</span> <span class="p">{</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry</span> <span class="p">:</span> <span class="kc">None</span> <span class="p">}</span>                                <span class="c1"># idom[b] contains exactly one block, the immediate dominator of b</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30"></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">postorder</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>                            <span class="c1"># reverse or not we do not care here, but do not visit the source block</span>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31"></a>            <span class="n">idom</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dom</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">-</span> <span class="p">{</span><span class="n">b</span><span class="p">},</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">dom</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span>  <span class="c1"># immediate dominator is the one with the maximum number of dominators (except the block itself)</span>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32"></a>        <span class="k">return</span> <span class="n">idom</span>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33"></a>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dominance_frontiers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35"></a>        <span class="n">idom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">immediate_dominators</span><span class="p">()</span>
</span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36"></a>        <span class="n">df</span> <span class="o">=</span> <span class="p">{</span> <span class="n">b</span> <span class="p">:</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reachable</span> <span class="p">}</span>
</span><span id="__span-12-37"><a id="__codelineno-12-37" name="__codelineno-12-37"></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">predecessors</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reachable</span><span class="p">):</span> <span class="c1"># iterate through junction points among reachable blocks</span>
</span><span id="__span-12-38"><a id="__codelineno-12-38" name="__codelineno-12-38"></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">predecessors</span><span class="p">:</span>
</span><span id="__span-12-39"><a id="__codelineno-12-39" name="__codelineno-12-39"></a>                <span class="n">runner</span> <span class="o">=</span> <span class="n">p</span>
</span><span id="__span-12-40"><a id="__codelineno-12-40" name="__codelineno-12-40"></a>                <span class="k">while</span> <span class="n">runner</span> <span class="o">!=</span> <span class="n">idom</span><span class="p">[</span><span class="n">b</span><span class="p">]:</span>
</span><span id="__span-12-41"><a id="__codelineno-12-41" name="__codelineno-12-41"></a>                    <span class="n">df</span><span class="p">[</span><span class="n">runner</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span id="__span-12-42"><a id="__codelineno-12-42" name="__codelineno-12-42"></a>                    <span class="n">runner</span> <span class="o">=</span> <span class="n">idom</span><span class="p">[</span><span class="n">runner</span><span class="p">]</span>
</span><span id="__span-12-43"><a id="__codelineno-12-43" name="__codelineno-12-43"></a>        <span class="k">return</span> <span class="n">df</span>
</span></code></pre></div></td></tr></table></div>
</details>
<p>I didn't invent anything new here, I took the simplest (and at the same time the slowest) methods, which can be easily found on Wikipedia.
Everything is calculated exactly according to the definitions I have provided.
First, the sets of dominators are calculated, then the dominance tree is derived from them, and the frontiers are derived from the tree.</p>
<h2 id="mem2reg_1">mem2reg</h2>
<p>Armed with the terminology, we can finally clearly define the algorithm for placing <span class="arithmatex">\(\phi\)</span>-functions in our control flow graph. Behold!</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>for each variable v
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>  queue all blocks containing store v
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>  while the queue is not empty
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>    pop one block b1
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>    for each block b2 in the dominance frontier of b1
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>      if we haven&#39;t placed a $\phi$-function for variable v yet
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>        insert it
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>        add b2 to the queue
</span></code></pre></div>
<p>It's all very simple, but there is one important nuance to remember: inserting a <span class="arithmatex">\(\phi\)</span>-function is somewhat akin to adding a <code>store</code>:
by adding a <span class="arithmatex">\(\phi\)</span>-function to block <code>b2</code>, we must also put it in the queue  for processing.</p>
<p>Note that at this stage we are adding <span class="arithmatex">\(\phi\)</span>-functions, but not filling in their arguments.
We will deal with this when removing <code>load</code> and <code>store</code>.
Let's look at the <a href="optimizer.py">complete code</a> for the mem2reg pass as I have implemented it:</p>
<details class="example">
<summary>mem2reg</summary>
<div class="language-py highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span>
<span class="normal"><a href="#__codelineno-14-14">14</a></span>
<span class="normal"><a href="#__codelineno-14-15">15</a></span>
<span class="normal"><a href="#__codelineno-14-16">16</a></span>
<span class="normal"><a href="#__codelineno-14-17">17</a></span>
<span class="normal"><a href="#__codelineno-14-18">18</a></span>
<span class="normal"><a href="#__codelineno-14-19">19</a></span>
<span class="normal"><a href="#__codelineno-14-20">20</a></span>
<span class="normal"><a href="#__codelineno-14-21">21</a></span>
<span class="normal"><a href="#__codelineno-14-22">22</a></span>
<span class="normal"><a href="#__codelineno-14-23">23</a></span>
<span class="normal"><a href="#__codelineno-14-24">24</a></span>
<span class="normal"><a href="#__codelineno-14-25">25</a></span>
<span class="normal"><a href="#__codelineno-14-26">26</a></span>
<span class="normal"><a href="#__codelineno-14-27">27</a></span>
<span class="normal"><a href="#__codelineno-14-28">28</a></span>
<span class="normal"><a href="#__codelineno-14-29">29</a></span>
<span class="normal"><a href="#__codelineno-14-30">30</a></span>
<span class="normal"><a href="#__codelineno-14-31">31</a></span>
<span class="normal"><a href="#__codelineno-14-32">32</a></span>
<span class="normal"><a href="#__codelineno-14-33">33</a></span>
<span class="normal"><a href="#__codelineno-14-34">34</a></span>
<span class="normal"><a href="#__codelineno-14-35">35</a></span>
<span class="normal"><a href="#__codelineno-14-36">36</a></span>
<span class="normal"><a href="#__codelineno-14-37">37</a></span>
<span class="normal"><a href="#__codelineno-14-38">38</a></span>
<span class="normal"><a href="#__codelineno-14-39">39</a></span>
<span class="normal"><a href="#__codelineno-14-40">40</a></span>
<span class="normal"><a href="#__codelineno-14-41">41</a></span>
<span class="normal"><a href="#__codelineno-14-42">42</a></span>
<span class="normal"><a href="#__codelineno-14-43">43</a></span>
<span class="normal"><a href="#__codelineno-14-44">44</a></span>
<span class="normal"><a href="#__codelineno-14-45">45</a></span>
<span class="normal"><a href="#__codelineno-14-46">46</a></span>
<span class="normal"><a href="#__codelineno-14-47">47</a></span>
<span class="normal"><a href="#__codelineno-14-48">48</a></span>
<span class="normal"><a href="#__codelineno-14-49">49</a></span>
<span class="normal"><a href="#__codelineno-14-50">50</a></span>
<span class="normal"><a href="#__codelineno-14-51">51</a></span>
<span class="normal"><a href="#__codelineno-14-52">52</a></span>
<span class="normal"><a href="#__codelineno-14-53">53</a></span>
<span class="normal"><a href="#__codelineno-14-54">54</a></span>
<span class="normal"><a href="#__codelineno-14-55">55</a></span>
<span class="normal"><a href="#__codelineno-14-56">56</a></span>
<span class="normal"><a href="#__codelineno-14-57">57</a></span>
<span class="normal"><a href="#__codelineno-14-58">58</a></span>
<span class="normal"><a href="#__codelineno-14-59">59</a></span>
<span class="normal"><a href="#__codelineno-14-60">60</a></span>
<span class="normal"><a href="#__codelineno-14-61">61</a></span>
<span class="normal"><a href="#__codelineno-14-62">62</a></span>
<span class="normal"><a href="#__codelineno-14-63">63</a></span>
<span class="normal"><a href="#__codelineno-14-64">64</a></span>
<span class="normal"><a href="#__codelineno-14-65">65</a></span>
<span class="normal"><a href="#__codelineno-14-66">66</a></span>
<span class="normal"><a href="#__codelineno-14-67">67</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">mem2reg</span><span class="p">(</span><span class="n">Optimizer</span><span class="p">):</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">):</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allocas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_promotable_allocas</span><span class="p">()</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">place_phi</span><span class="p">()</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6"></a>        <span class="n">stack</span> <span class="o">=</span> <span class="p">[{}]</span> <span class="c1"># stack of maps (variable -&gt; value); necessary for storing context while branching</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">remove_store_load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entry</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">set</span><span class="p">(),</span> <span class="n">stack</span><span class="p">)</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8"></a>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_promotable_allocas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10"></a>        <span class="n">allocas</span> <span class="o">=</span> <span class="p">{</span> <span class="n">i</span><span class="o">.</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry</span><span class="o">.</span><span class="n">instructions</span> <span class="k">if</span> <span class="s1">&#39;alloca&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">string</span> <span class="p">}</span> <span class="c1"># find all allocas in the entry block</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11"></a>        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">allocas</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>             <span class="c1"># for every variable</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12"></a>            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reachable</span><span class="p">:</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13"></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">instructions</span><span class="p">:</span>            <span class="c1"># for every instruction in the CFG</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14"></a>                    <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;* %</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">string</span><span class="p">:</span>       <span class="c1"># if we find a funcall with a reference to the variable</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15"></a>                        <span class="n">allocas</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>        <span class="c1"># then the variable is not promotable</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry</span><span class="o">.</span><span class="n">instructions</span><span class="p">[:]:</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17"></a>            <span class="k">if</span> <span class="s1">&#39;alloca&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">string</span> <span class="ow">and</span> <span class="n">i</span><span class="o">.</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">allocas</span><span class="p">:</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">entry</span><span class="o">.</span><span class="n">instructions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>   <span class="c1"># remove promotable allocas</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19"></a>        <span class="k">return</span> <span class="n">allocas</span> <span class="c1"># variable name -&gt; type dictionary</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20"></a>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">place_phi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                        <span class="c1"># Fig 9.9b in [Cooper and Torczon, Engineering a Compiler BrochÃ©]</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22"></a>        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dominance_frontiers</span><span class="p">()</span>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23"></a>        <span class="n">phi_places</span> <span class="o">=</span> <span class="p">{</span> <span class="n">v</span><span class="p">:</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocas</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">}</span>   <span class="c1"># map (variable -&gt; set of basic blocks)</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24"></a>        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocas</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25"></a>            <span class="n">blocks_with_store</span> <span class="o">=</span> <span class="p">{</span> <span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reachable</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">instructions</span> <span class="k">if</span> <span class="s1">&#39;store&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">string</span> <span class="ow">and</span> <span class="n">i</span><span class="o">.</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">v</span> <span class="p">}</span>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26"></a>            <span class="n">blocks_to_consider</span> <span class="o">=</span> <span class="n">blocks_with_store</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27"></a>            <span class="k">while</span> <span class="n">blocks_to_consider</span><span class="p">:</span>
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28"></a>                <span class="n">block</span> <span class="o">=</span> <span class="n">blocks_to_consider</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29"></a>                <span class="k">for</span> <span class="n">frontier</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">block</span><span class="p">]:</span>
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30"></a>                    <span class="k">if</span> <span class="n">frontier</span> <span class="ow">in</span> <span class="n">phi_places</span><span class="p">[</span><span class="n">v</span><span class="p">]:</span> <span class="k">continue</span>
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31"></a>                    <span class="n">phi_places</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">frontier</span><span class="p">)</span>
</span><span id="__span-14-32"><a id="__codelineno-14-32" name="__codelineno-14-32"></a>                    <span class="n">blocks_to_consider</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">frontier</span><span class="p">)</span>
</span><span id="__span-14-33"><a id="__codelineno-14-33" name="__codelineno-14-33"></a>        <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">bb</span> <span class="ow">in</span> <span class="n">phi_places</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>                        <span class="c1"># insert phi nodes (for the moment without choices)</span>
</span><span id="__span-14-34"><a id="__codelineno-14-34" name="__codelineno-14-34"></a>            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">:</span>
</span><span id="__span-14-35"><a id="__codelineno-14-35" name="__codelineno-14-35"></a>                <span class="n">b</span><span class="o">.</span><span class="n">phi_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Phi</span><span class="p">(</span><span class="n">v</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocas</span><span class="p">[</span><span class="n">v</span><span class="p">]))</span>
</span><span id="__span-14-36"><a id="__codelineno-14-36" name="__codelineno-14-36"></a>
</span><span id="__span-14-37"><a id="__codelineno-14-37" name="__codelineno-14-37"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_store_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">visited</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
</span><span id="__span-14-38"><a id="__codelineno-14-38" name="__codelineno-14-38"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">find_variable</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>                <span class="c1"># walk the stack back until</span>
</span><span id="__span-14-39"><a id="__codelineno-14-39" name="__codelineno-14-39"></a>            <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>           <span class="c1"># the current variable instance is found</span>
</span><span id="__span-14-40"><a id="__codelineno-14-40" name="__codelineno-14-40"></a>                <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">frame</span><span class="p">:</span> <span class="k">return</span> <span class="n">frame</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>      <span class="c1"># N.B. we suppose that the variables were initialized explicitly</span>
</span><span id="__span-14-41"><a id="__codelineno-14-41" name="__codelineno-14-41"></a>
</span><span id="__span-14-42"><a id="__codelineno-14-42" name="__codelineno-14-42"></a>        <span class="k">for</span> <span class="n">phi</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">phi_functions</span><span class="p">:</span>             <span class="c1"># place phi node choice for the current path</span>
</span><span id="__span-14-43"><a id="__codelineno-14-43" name="__codelineno-14-43"></a>            <span class="n">v</span> <span class="o">=</span> <span class="n">phi</span><span class="o">.</span><span class="n">reg</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">label</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>       <span class="c1"># phi saves the choice into a register named foo_bar, where foo is the name of the variable, and bar is the name of the basic block</span>
</span><span id="__span-14-44"><a id="__codelineno-14-44" name="__codelineno-14-44"></a>            <span class="n">val</span> <span class="o">=</span> <span class="n">find_variable</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>
</span><span id="__span-14-45"><a id="__codelineno-14-45" name="__codelineno-14-45"></a>            <span class="n">phi</span><span class="o">.</span><span class="n">choice</span><span class="p">[</span><span class="n">prev</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span><span id="__span-14-46"><a id="__codelineno-14-46" name="__codelineno-14-46"></a>            <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi</span><span class="o">.</span><span class="n">reg</span>
</span><span id="__span-14-47"><a id="__codelineno-14-47" name="__codelineno-14-47"></a>
</span><span id="__span-14-48"><a id="__codelineno-14-48" name="__codelineno-14-48"></a>        <span class="k">if</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span> <span class="k">return</span>                 <span class="c1"># we need to revisit blocks with phi functions as many times as we have incoming edges,</span>
</span><span id="__span-14-49"><a id="__codelineno-14-49" name="__codelineno-14-49"></a>        <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>                          <span class="c1"># therefore the visited check is made after the choice placement</span>
</span><span id="__span-14-50"><a id="__codelineno-14-50" name="__codelineno-14-50"></a>
</span><span id="__span-14-51"><a id="__codelineno-14-51" name="__codelineno-14-51"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">instructions</span><span class="p">[:]:</span>             <span class="c1"># iterate through a copy since we modify the list</span>
</span><span id="__span-14-52"><a id="__codelineno-14-52" name="__codelineno-14-52"></a>            <span class="k">if</span> <span class="s1">&#39;load&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">string</span> <span class="ow">and</span> <span class="n">i</span><span class="o">.</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocas</span><span class="p">:</span>
</span><span id="__span-14-53"><a id="__codelineno-14-53" name="__codelineno-14-53"></a>                <span class="n">val</span> <span class="o">=</span> <span class="n">find_variable</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">stack</span><span class="p">)</span>
</span><span id="__span-14-54"><a id="__codelineno-14-54" name="__codelineno-14-54"></a>                <span class="n">block</span><span class="o">.</span><span class="n">instructions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="__span-14-55"><a id="__codelineno-14-55" name="__codelineno-14-55"></a>                <span class="n">block</span><span class="o">.</span><span class="n">find_and_replace</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>
</span><span id="__span-14-56"><a id="__codelineno-14-56" name="__codelineno-14-56"></a>            <span class="k">elif</span> <span class="s1">&#39;store&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">string</span> <span class="ow">and</span> <span class="n">i</span><span class="o">.</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocas</span><span class="p">:</span>
</span><span id="__span-14-57"><a id="__codelineno-14-57" name="__codelineno-14-57"></a>                <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="o">.</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-14-58"><a id="__codelineno-14-58" name="__codelineno-14-58"></a>                <span class="n">block</span><span class="o">.</span><span class="n">instructions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="__span-14-59"><a id="__codelineno-14-59" name="__codelineno-14-59"></a>            <span class="k">elif</span> <span class="s1">&#39;br i1&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">string</span><span class="p">:</span>
</span><span id="__span-14-60"><a id="__codelineno-14-60" name="__codelineno-14-60"></a>                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
</span><span id="__span-14-61"><a id="__codelineno-14-61" name="__codelineno-14-61"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">remove_store_load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">block</span><span class="p">,</span> <span class="n">visited</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>
</span><span id="__span-14-62"><a id="__codelineno-14-62" name="__codelineno-14-62"></a>                <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="__span-14-63"><a id="__codelineno-14-63" name="__codelineno-14-63"></a>                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
</span><span id="__span-14-64"><a id="__codelineno-14-64" name="__codelineno-14-64"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">remove_store_load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">op</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">block</span><span class="p">,</span> <span class="n">visited</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>
</span><span id="__span-14-65"><a id="__codelineno-14-65" name="__codelineno-14-65"></a>                <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="__span-14-66"><a id="__codelineno-14-66" name="__codelineno-14-66"></a>            <span class="k">elif</span> <span class="s1">&#39;br label&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">string</span><span class="p">:</span>
</span><span id="__span-14-67"><a id="__codelineno-14-67" name="__codelineno-14-67"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">remove_store_load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>  <span class="n">block</span><span class="p">,</span> <span class="n">visited</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
</details>
<p>To call it, you need to uncomment lines 71-72 in the <a href="fib.py">fib.py</a> file.</p>
<p>The <code>mem2reg</code> class inherits from the <code>Optimizer</code> class, so I have full access to dominance functions.
The constructor does all the work.
First, it finds which variables in the <code>cfg</code> are subject to this optimization using <code>remove_promotable_allocas()</code>.
This function removes <code>alloca</code> of local variables from which no address is taken, i.e., it removes all local variables from the stack that are not accessible for modification by other functions.
Then <code>place_phi()</code> inserts <span class="arithmatex">\(\phi\)</span>-functions according to the above algorithm with frontiers.
The remaining task is to fill their arguments, which is done by <code>remove_store_load()</code>.</p>
<p>Let's see how it works, using the same Fibonacci numbers example.
After removing <code>alloca</code> (in this case, all of them are removed) and placing <span class="arithmatex">\(\phi\)</span>-functions, we get the following intermediate code:</p>
<details class="example">
<summary><span class="arithmatex">\(\phi\)</span>-node placement</summary>
<div class="language-llvm highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">define</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@fib</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv">%n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="nl">entry:</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">        </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%n</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%n.addr</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">        </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%a</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">        </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%b</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">        </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%i</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">        </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%c</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">        </span><span class="nv nv-Anonymous">%0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%n.addr</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w">        </span><span class="nv">%cmp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">eq</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">        </span><span class="k">br</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%cmp</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%if.then</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%if.end</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="nl">if.then:</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="w">        </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%retval</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="w">        </span><span class="k">br</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%return</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="nl">if.end:</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">        </span><span class="k">br</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%while.cond</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="nl">while.cond:</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">        </span><span class="nv">%a_while.cond</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">]</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="w">        </span><span class="nv">%b_while.cond</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">]</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="w">        </span><span class="nv">%i_while.cond</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">]</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="w">        </span><span class="nv">%c_while.cond</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">]</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="w">        </span><span class="nv nv-Anonymous">%1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%i</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="w">        </span><span class="nv nv-Anonymous">%2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%n.addr</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="w">        </span><span class="nv">%cmp1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">slt</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">,</span><span class="w"> </span><span class="nv nv-Anonymous">%2</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a><span class="w">        </span><span class="k">br</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%cmp1</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%while.body</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%while.end</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a><span class="nl">while.body:</span>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a><span class="w">        </span><span class="nv nv-Anonymous">%3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%b</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a><span class="w">        </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%3</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%c</span>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a><span class="w">        </span><span class="nv nv-Anonymous">%4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%a</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a><span class="w">        </span><span class="nv nv-Anonymous">%5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%b</span>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a><span class="w">        </span><span class="nv">%add</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%4</span><span class="p">,</span><span class="w"> </span><span class="nv nv-Anonymous">%5</span>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a><span class="w">        </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%add</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%b</span>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a><span class="w">        </span><span class="nv nv-Anonymous">%6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%c</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a><span class="w">        </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%6</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%a</span>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a><span class="w">        </span><span class="nv nv-Anonymous">%7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%i</span>
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a><span class="w">        </span><span class="nv">%add2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%7</span><span class="p">,</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a><span class="w">        </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%add2</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%i</span>
</span><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a><span class="w">        </span><span class="k">br</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%while.cond</span>
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a><span class="nl">while.end:</span>
</span><span id="__span-15-39"><a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a><span class="w">        </span><span class="nv nv-Anonymous">%8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%b</span>
</span><span id="__span-15-40"><a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a><span class="w">        </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%8</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%retval</span>
</span><span id="__span-15-41"><a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a><span class="w">        </span><span class="k">br</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%return</span>
</span><span id="__span-15-42"><a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a><span class="nl">return:</span>
</span><span id="__span-15-43"><a id="__codelineno-15-43" name="__codelineno-15-43" href="#__codelineno-15-43"></a><span class="w">        </span><span class="nv">%retval_return</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">]</span>
</span><span id="__span-15-44"><a id="__codelineno-15-44" name="__codelineno-15-44" href="#__codelineno-15-44"></a><span class="w">        </span><span class="nv">%a_return</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">]</span>
</span><span id="__span-15-45"><a id="__codelineno-15-45" name="__codelineno-15-45" href="#__codelineno-15-45"></a><span class="w">        </span><span class="nv">%b_return</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">]</span>
</span><span id="__span-15-46"><a id="__codelineno-15-46" name="__codelineno-15-46" href="#__codelineno-15-46"></a><span class="w">        </span><span class="nv">%i_return</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">]</span>
</span><span id="__span-15-47"><a id="__codelineno-15-47" name="__codelineno-15-47" href="#__codelineno-15-47"></a><span class="w">        </span><span class="nv">%c_return</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">]</span>
</span><span id="__span-15-48"><a id="__codelineno-15-48" name="__codelineno-15-48" href="#__codelineno-15-48"></a><span class="w">        </span><span class="nv nv-Anonymous">%9</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%retval</span>
</span><span id="__span-15-49"><a id="__codelineno-15-49" name="__codelineno-15-49" href="#__codelineno-15-49"></a><span class="w">        </span><span class="k">ret</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%9</span>
</span><span id="__span-15-50"><a id="__codelineno-15-50" name="__codelineno-15-50" href="#__codelineno-15-50"></a><span class="p">}</span>
</span></code></pre></div>
</details>
<p>I'm not providing a picture because llvm refuses to draw it :)
It makes sense, the code is broken: in the first basic block, the register <code>%a</code> is not defined, and the <span class="arithmatex">\(\phi\)</span>-functions, though correctly placed, are not valid instructions without arguments.</p>
<p>Let's do a depth-first search, starting, obviously, from the entry point of the program.
So, we have the <code>entry</code> block:</p>
<div class="language-llvm highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="nl">entry:</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">        </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%n</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%n.addr</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">        </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%a</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">        </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%b</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">        </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%i</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">        </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%c</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">        </span><span class="nv nv-Anonymous">%0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%n.addr</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">        </span><span class="nv">%cmp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">eq</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">        </span><span class="k">br</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%cmp</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%if.then</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%if.end</span>
</span></code></pre></div>
<p>We go through all the instructions sequentially, removing all <code>store</code> and <code>load</code> instructions while examining their arguments.
The first instruction stores <code>%n</code> at the address <code>%n.addr</code>, meaning that any <code>load</code> from this address in this block can be replaced with <code>%n</code>, and in particular, <code>%0</code> is also replaced with <code>%n</code>.
Similarly, we remember the values for <code>%a</code>, <code>%b</code>, <code>%i</code>, <code>%c</code>, and remove their <code>store</code>.
After processing, <code>entry</code> looks like this:</p>
<div class="language-llvm highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="nl">entry:</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">        </span><span class="nv">%cmp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">eq</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%n</span><span class="p">,</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">        </span><span class="k">br</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%cmp</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%if.then</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%if.end</span>
</span></code></pre></div>
<p>The <code>entry</code> block has two successors - <code>if.then</code> and <code>if.end</code>. Since we are doing a depth-first traversal, we first go to <code>if.then</code>. It looks like this:</p>
<div class="language-llvm highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="nl">if.then:</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">        </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%retval</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">        </span><span class="k">br</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%return</span>
</span></code></pre></div>
<p>We remove the <code>store</code>, remember that <code>%retval</code> is <code>0</code>, and go to <code>return</code>. It looks like this:</p>
<div class="language-llvm highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="nl">return:</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">        </span><span class="nv">%retval_return</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">]</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">        </span><span class="nv">%a_return</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">]</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">        </span><span class="nv">%b_return</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">]</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">        </span><span class="nv">%i_return</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">]</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">        </span><span class="nv">%c_return</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">]</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">        </span><span class="nv nv-Anonymous">%9</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%retval</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">        </span><span class="k">ret</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%9</span>
</span></code></pre></div>
<p>It's time to start filling in the <span class="arithmatex">\(\phi\)</span>-functions.
We came from the <code>if.then</code> branch, so we remember that <code>%retval</code> in this branch is <code>0</code>, <code>%a</code> is <code>0</code>, <code>%b</code> is <code>1</code>, <code>%i</code> is <code>1</code>, and <code>%c</code> is <code>0</code>.
We fill in the corresponding argument of the <span class="arithmatex">\(\phi\)</span>-functions, remove the <code>load</code>, replacing <code>%9</code> with <code>%retval_return</code>.
After processing, the block looks like this:</p>
<div class="language-llvm highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="nl">return:</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="w">        </span><span class="nv">%retval_return</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="nv">%if.then</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">]</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">        </span><span class="nv">%a_return</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="nv">%if.then</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">]</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">        </span><span class="nv">%b_return</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="nv">%if.then</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">]</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">        </span><span class="nv">%i_return</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="nv">%if.then</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">]</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">        </span><span class="nv">%c_return</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">phi</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">[</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="nv">%if.then</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="err">?</span><span class="p">]</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">        </span><span class="k">ret</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%retval_return</span>
</span></code></pre></div>
<p>This is a terminal block, so the depth-first traversal returns to <code>if.end</code> (nothing to do there), then <code>while.cond</code>, and so on.</p>
<p>As a result, my code generates the following control flow graph:</p>
<p><a href="fib3_dot.png"><img alt="" src="fib3_dot.png" /></a></p>
<p>Let's compare it with what llvm generated from clang's output:</p>
<p><a href="fib2_dot.png"><img alt="" src="fib2_dot.png" /></a></p>
<p>As you can see, llvm was a bit smarter: it noticed that <code>a</code>, <code>b</code>, <code>i</code>, <code>c</code> are not used in the <code>return</code> block and did not pass them through,
and it also understood that <code>c</code> is overwritten in <code>while.body</code>, so it didn't pass it through <code>while.cond</code>.
Otherwise, the result is identical, so I am quite satisfied with my toy compiler.</p>
<p>Well, it's time to integrate this with the compiler.
All the tests pass, hooray!</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>ssloy@periwinkle:~/tinyoptimizer$<span class="w"> </span>make<span class="w"> </span><span class="nb">test</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>Testing<span class="w"> </span>test-programs/nontrivial/mandelbrot.wend...<span class="w"> </span>ok
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>Testing<span class="w"> </span>test-programs/nontrivial/bitwise.wend...<span class="w"> </span>ok
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>Testing<span class="w"> </span>test-programs/nontrivial/trig-hp12c.wend...<span class="w"> </span>ok
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>Testing<span class="w"> </span>test-programs/nontrivial/sqrt.wend...<span class="w"> </span>ok
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>Testing<span class="w"> </span>test-programs/simple/fixed-point.wend...<span class="w"> </span>ok
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>Testing<span class="w"> </span>test-programs/simple/eight-queens.wend...<span class="w"> </span>ok
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>Testing<span class="w"> </span>test-programs/simple/mutual-recursion.wend...<span class="w"> </span>ok
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>Testing<span class="w"> </span>test-programs/simple/popcount.wend...<span class="w"> </span>ok
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>Testing<span class="w"> </span>test-programs/simple/collatz.wend...<span class="w"> </span>ok
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>Testing<span class="w"> </span>test-programs/simple/sopfr.wend...<span class="w"> </span>ok
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>Testing<span class="w"> </span>test-programs/elementary/helloworld.wend...<span class="w"> </span>ok
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>Testing<span class="w"> </span>test-programs/elementary/arithmetic.wend...<span class="w"> </span>ok
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>Testing<span class="w"> </span>test-programs/elementary/scope.wend...<span class="w"> </span>ok
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>Testing<span class="w"> </span>test-programs/elementary/overload.wend...<span class="w"> </span>ok
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>Testing<span class="w"> </span>test-programs/elementary/int-overflow.wend...<span class="w"> </span>ok
</span></code></pre></div>
<p>The compiler code <a href="https://github.com/ssloy/tinyoptimizer/tree/1fc65c278c98ec0859ffffc1d7c828ffa93fbea4">lives here</a>,
and you can play with mem2reg manually, without the rest of the compiler, using the files from this article. Here are the links again:</p>
<ul>
<li><a href="ir.py">ir.py</a></li>
<li><a href="optimizer.py">optimizer.py</a></li>
<li><a href="fib.py">fib.py</a></li>
</ul>
<hr/>
<h3>Comments</h3>
<script src="https://giscus.app/client.js"
        data-repo="ssloy/ssloy.github.io"
        data-repo-id="R_kgDOLIjENg"
        data-category="General"
        data-category-id="DIC_kwDOLIjENs4CnFkC"
        data-mapping="pathname"
        data-strict="1"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "content.code.annotate", "content.tooltips"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>